## [ç³»ç»Ÿè®¾è®¡å…¥é—¨](https://github.com/donnemartin/system-design-primer)

æœ€åï¼ŒGithub ä¸Šæœ‰ä¸€ä¸ªä¼˜ç§€çš„å¼€æºé¡¹ç›®ï¼Œä¸“é—¨æ”¶é›†äº†å¾ˆå¤šå¤§å‹ç³»ç»Ÿè®¾è®¡çš„æ¡ˆä¾‹å’Œè§£æï¼Œè€Œä¸”æœ‰ä¸­æ–‡ç‰ˆæœ¬ï¼Œä¸Šé¢è¿™ä¸ªå›¾ä¹Ÿå‡ºè‡ªè¯¥é¡¹ç›®ã€‚å¯¹ç³»ç»Ÿè®¾è®¡æ„Ÿå…´è¶£çš„è¯»è€…å¯ä»¥ç‚¹å‡» [è¿™é‡Œ](https://github.com/donnemartin/system-design-primer) æŸ¥çœ‹ã€‚

#### [146. LRU ç¼“å­˜æœºåˆ¶](https://leetcode-cn.com/problems/lru-cache/)

![image-20210618150200089](assets/image-20210618150200089.png)

![image-20210618150209519](assets/image-20210618150209519.png)

LRU ç®—æ³•çš„æ·˜æ±°ç­–ç•¥æ˜¯ Least Recently Usedï¼Œä¹Ÿå°±æ˜¯æ¯æ¬¡æ·˜æ±°é‚£äº›æœ€ä¹…æ²¡è¢«ä½¿ç”¨çš„æ•°æ®ï¼›

LRU ç¼“å­˜ç®—æ³•çš„æ ¸å¿ƒæ•°æ®ç»“æ„å°±æ˜¯å“ˆå¸Œé“¾è¡¨ï¼Œæ˜¯åŒå‘é“¾è¡¨å’Œå“ˆå¸Œè¡¨çš„ç»“åˆä½“ã€‚è¿™ä¸ªæ•°æ®ç»“æ„é•¿è¿™æ ·ï¼š

<img src="assets/30af4fb8bfe13c9ffb55818ccb70cc57b6c0a508.jpg" alt="img" style="zoom:50%;" />

å€ŸåŠ©è¿™ä¸ªç»“æ„ï¼Œæˆ‘ä»¬æ¥é€ä¸€åˆ†æä¸Šé¢çš„ 3 ä¸ªæ¡ä»¶ï¼š

1ã€å¦‚æœæˆ‘ä»¬æ¯æ¬¡é»˜è®¤ä»é“¾è¡¨å°¾éƒ¨æ·»åŠ å…ƒç´ ï¼Œé‚£ä¹ˆæ˜¾ç„¶**è¶Šé å°¾éƒ¨çš„å…ƒç´ å°±æ˜¯æœ€è¿‘ä½¿ç”¨çš„ï¼Œè¶Šé å¤´éƒ¨çš„å…ƒç´ å°±æ˜¯æœ€ä¹…æœªä½¿ç”¨çš„**ã€‚

2ã€å¯¹äºæŸä¸€ä¸ª `key`ï¼Œæˆ‘ä»¬å¯ä»¥**é€šè¿‡å“ˆå¸Œè¡¨å¿«é€Ÿå®šä½åˆ°é“¾è¡¨ä¸­çš„èŠ‚ç‚¹**ã€‚

3ã€é“¾è¡¨æ˜¾ç„¶æ˜¯æ”¯æŒåœ¨ä»»æ„ä½ç½®å¿«é€Ÿæ’å…¥å’Œåˆ é™¤çš„ï¼Œæ”¹æ”¹æŒ‡é’ˆå°±è¡Œã€‚åªä¸è¿‡ä¼ ç»Ÿçš„é“¾è¡¨æ— æ³•æŒ‰ç…§ç´¢å¼•å¿«é€Ÿè®¿é—®æŸä¸€ä¸ªä½ç½®çš„å…ƒç´ ï¼Œè€Œè¿™é‡Œ**å€ŸåŠ©å“ˆå¸Œè¡¨ï¼Œå¯ä»¥é€šè¿‡ `key` å¿«é€Ÿæ˜ å°„åˆ°ä»»æ„ä¸€ä¸ªé“¾è¡¨èŠ‚ç‚¹ï¼Œç„¶åè¿›è¡Œæ’å…¥å’Œåˆ é™¤**ã€‚

**ä¹Ÿè®¸è¯»è€…ä¼šé—®ï¼Œä¸ºä»€ä¹ˆè¦æ˜¯åŒå‘é“¾è¡¨ï¼Œå•é“¾è¡¨è¡Œä¸è¡Œï¼Ÿå¦å¤–ï¼Œæ—¢ç„¶å“ˆå¸Œè¡¨ä¸­å·²ç»å­˜äº†** **`key`**ï¼Œä¸ºä»€ä¹ˆé“¾è¡¨ä¸­è¿˜è¦å­˜ **`key`** **å’Œ** **`val`** **å‘¢ï¼Œåªå­˜** **`val`** **ä¸å°±è¡Œäº†**ï¼Ÿ

ç­‰æˆ‘ä»¬äº²è‡ªå®ç° LRU ç®—æ³•ä¹‹åæ‰èƒ½ç†è§£ï¼Œæ‰€ä»¥æˆ‘ä»¬å¼€å§‹çœ‹ä»£ç å§ï½

ä¸‹é¢å…ˆæ‰‹åŠ¨å®ç°`LinkedHashMap`ç±»:

##### ä¸€ã€æ‰‹åŠ¨å®ç°`LinkedHashMap`ç±»

é¦–å…ˆï¼Œæˆ‘ä»¬æŠŠåŒé“¾è¡¨çš„èŠ‚ç‚¹ç±»å†™å‡ºæ¥ï¼Œä¸ºäº†ç®€åŒ–ï¼Œ`key` å’Œ `val` éƒ½è®¤ä¸ºæ˜¯ int ç±»å‹ï¼š

```java
class Node {
    public int key, val;
    public Node next, prev;
    public Node(int k, int v) {
        this.key = k;
        this.val = v;
    }
}
```

ç„¶åä¾é æˆ‘ä»¬çš„ `Node` ç±»å‹æ„å»ºä¸€ä¸ªåŒé“¾è¡¨ï¼Œå®ç°å‡ ä¸ª LRU ç®—æ³•å¿…é¡»çš„ APIï¼š



```java
class DoubleList {  
    // å¤´å°¾è™šèŠ‚ç‚¹
    private Node head, tail;  
    // é“¾è¡¨å…ƒç´ æ•°
    private int size;

    public DoubleList() {
        // åˆå§‹åŒ–åŒå‘é“¾è¡¨çš„æ•°æ®
        head = new Node(0, 0);
        tail = new Node(0, 0);
        head.next = tail;
        tail.prev = head;
        size = 0;
    }

    // åœ¨é“¾è¡¨å°¾éƒ¨æ·»åŠ èŠ‚ç‚¹ xï¼Œæ—¶é—´ O(1)
    public void addLast(Node x) {
        x.prev = tail.prev;
        x.next = tail;
        tail.prev.next = x;
        tail.prev = x;
        size++;
    }

    // åˆ é™¤é“¾è¡¨ä¸­çš„ x èŠ‚ç‚¹ï¼ˆx ä¸€å®šå­˜åœ¨ï¼‰
    // ç”±äºæ˜¯åŒé“¾è¡¨ä¸”ç»™çš„æ˜¯ç›®æ ‡ Node èŠ‚ç‚¹ï¼Œæ—¶é—´ O(1)
    public void remove(Node x) {
        x.prev.next = x.next;
        x.next.prev = x.prev;
        size--;
    }

    // åˆ é™¤é“¾è¡¨ä¸­ç¬¬ä¸€ä¸ªèŠ‚ç‚¹ï¼Œå¹¶è¿”å›è¯¥èŠ‚ç‚¹ï¼Œæ—¶é—´ O(1)
    public Node removeFirst() {
        if (head.next == tail)
            return null;
        Node first = head.next;
        remove(first);
        return first;
    }

    // è¿”å›é“¾è¡¨é•¿åº¦ï¼Œæ—¶é—´ O(1)
    public int size() { return size; }

}
```

ä¸ªäººæ„Ÿæ‚Ÿï¼š`addLast(Node x)`å’Œ`remove(Node x)`å‡½æ•°æ‰€éœ€çš„å‚æ•°æ˜¯ä» `map`ä¸­è·å–çš„ï¼Œä¹Ÿå°±æ˜¯`map`å’Œ`DoubleList`ä¸­å­˜æ”¾çš„æ˜¯åŒä¸€ä¸ª`Node`å¯¹è±¡ï¼Œå› æ­¤åœ¨`remove(Node x)`å‡½æ•°ä¸­ï¼Œå¯ä»¥ç›´æ¥ä½¿ç”¨`x.prev.next = x.next;x.next.prev = x.prev;`åˆ é™¤èŠ‚ç‚¹ï¼Œè€Œä¸ç”¨éå†`DoubleList`å¯»æ‰¾`Node`å¯¹è±¡ã€‚å³**å€ŸåŠ©å“ˆå¸Œè¡¨ï¼Œå¯ä»¥é€šè¿‡ `key` å¿«é€Ÿæ˜ å°„åˆ°ä»»æ„ä¸€ä¸ªé“¾è¡¨èŠ‚ç‚¹ï¼Œç„¶åè¿›è¡Œæ’å…¥å’Œåˆ é™¤**ã€‚

åˆ°è¿™é‡Œå°±èƒ½å›ç­”åˆšæ‰ã€Œä¸ºä»€ä¹ˆå¿…é¡»è¦ç”¨åŒå‘é“¾è¡¨ã€çš„é—®é¢˜äº†ï¼Œå› ä¸ºæˆ‘ä»¬éœ€è¦åˆ é™¤æ“ä½œã€‚åˆ é™¤ä¸€ä¸ªèŠ‚ç‚¹ä¸å…‰è¦å¾—åˆ°è¯¥èŠ‚ç‚¹æœ¬èº«çš„æŒ‡é’ˆï¼Œä¹Ÿéœ€è¦æ“ä½œå…¶å‰é©±èŠ‚ç‚¹çš„æŒ‡é’ˆï¼Œè€ŒåŒå‘é“¾è¡¨æ‰èƒ½æ”¯æŒç›´æ¥æŸ¥æ‰¾å‰é©±ï¼Œä¿è¯æ“ä½œçš„æ—¶é—´å¤æ‚åº¦ O(1)ã€‚

æœ‰äº†åŒå‘é“¾è¡¨çš„å®ç°ï¼Œæˆ‘ä»¬åªéœ€è¦åœ¨ LRU ç®—æ³•ä¸­æŠŠå®ƒå’Œå“ˆå¸Œè¡¨ç»“åˆèµ·æ¥å³å¯ï¼Œå…ˆæ­å‡ºä»£ç æ¡†æ¶ï¼š

```java
class LRUCache {
    // key -> Node(key, val)
    private HashMap<Integer, Node> map;
    // Node(k1, v1) <-> Node(k2, v2)...
    private DoubleList cache;
    // æœ€å¤§å®¹é‡
    private int cap;

    public LRUCache(int capacity) {
        this.cap = capacity;
        map = new HashMap<>();
        cache = new DoubleList();
    }
```

å…ˆä¸æ…Œå»å®ç° LRU ç®—æ³•çš„ `get` å’Œ `put` æ–¹æ³•ã€‚ç”±äºæˆ‘ä»¬è¦åŒæ—¶ç»´æŠ¤ä¸€ä¸ªåŒé“¾è¡¨ `cache` å’Œä¸€ä¸ªå“ˆå¸Œè¡¨ `map`ï¼Œå¾ˆå®¹æ˜“æ¼æ‰ä¸€äº›æ“ä½œï¼Œæ¯”å¦‚è¯´åˆ é™¤æŸä¸ª `key` æ—¶ï¼Œåœ¨ `cache` ä¸­åˆ é™¤äº†å¯¹åº”çš„ `Node`ï¼Œä½†æ˜¯å´å¿˜è®°åœ¨ `map` ä¸­åˆ é™¤ `key`ã€‚

**è§£å†³è¿™ç§é—®é¢˜çš„æœ‰æ•ˆæ–¹æ³•æ˜¯ï¼šåœ¨è¿™ä¸¤ç§æ•°æ®ç»“æ„ä¹‹ä¸Šæä¾›ä¸€å±‚æŠ½è±¡ API**ã€‚

è¯´çš„æœ‰ç‚¹ç„å¹»ï¼Œå®é™…ä¸Šå¾ˆç®€å•ï¼Œå°±æ˜¯å°½é‡è®© LRU çš„ä¸»æ–¹æ³• `get` å’Œ `put` é¿å…ç›´æ¥æ“ä½œ `map` å’Œ `cache` çš„ç»†èŠ‚ã€‚æˆ‘ä»¬å¯ä»¥å…ˆå®ç°ä¸‹é¢å‡ ä¸ªå‡½æ•°ï¼š

```java
/* å°†æŸä¸ª key æå‡ä¸ºæœ€è¿‘ä½¿ç”¨çš„ */
private void makeRecently(int key) {
    Node x = map.get(key);
    // å…ˆä»é“¾è¡¨ä¸­åˆ é™¤è¿™ä¸ªèŠ‚ç‚¹
    cache.remove(x);
    // é‡æ–°æ’åˆ°é˜Ÿå°¾
    cache.addLast(x);
}

/* æ·»åŠ æœ€è¿‘ä½¿ç”¨çš„å…ƒç´  */
private void addRecently(int key, int val) {
    Node x = new Node(key, val);
    // é“¾è¡¨å°¾éƒ¨å°±æ˜¯æœ€è¿‘ä½¿ç”¨çš„å…ƒç´ 
    cache.addLast(x);
    // åˆ«å¿˜äº†åœ¨ map ä¸­æ·»åŠ  key çš„æ˜ å°„
    map.put(key, x);
}

/* åˆ é™¤æŸä¸€ä¸ª key */
private void deleteKey(int key) {
    Node x = map.get(key);
    // ä»é“¾è¡¨ä¸­åˆ é™¤
    cache.remove(x);
    // ä» map ä¸­åˆ é™¤
    map.remove(key);
}

/* åˆ é™¤æœ€ä¹…æœªä½¿ç”¨çš„å…ƒç´  */
private void removeLeastRecently() {
    // é“¾è¡¨å¤´éƒ¨çš„ç¬¬ä¸€ä¸ªå…ƒç´ å°±æ˜¯æœ€ä¹…æœªä½¿ç”¨çš„
    Node deletedNode = cache.removeFirst();
    // åŒæ—¶åˆ«å¿˜äº†ä» map ä¸­åˆ é™¤å®ƒçš„ key
    int deletedKey = deletedNode.key;
    map.remove(deletedKey);
}
```

è¿™é‡Œå°±èƒ½å›ç­”ä¹‹å‰çš„é—®ç­”é¢˜ã€Œä¸ºä»€ä¹ˆè¦åœ¨é“¾è¡¨ä¸­åŒæ—¶å­˜å‚¨ key å’Œ valï¼Œè€Œä¸æ˜¯åªå­˜å‚¨ valã€ï¼Œæ³¨æ„ `removeLeastRecently` å‡½æ•°ä¸­ï¼Œæˆ‘ä»¬éœ€è¦ç”¨ `deletedNode` å¾—åˆ° `deletedKey`ã€‚

ä¸Šè¿°æ–¹æ³•å°±æ˜¯ç®€å•çš„æ“ä½œå°è£…ï¼Œè°ƒç”¨è¿™äº›å‡½æ•°å¯ä»¥é¿å…ç›´æ¥æ“ä½œ `cache` é“¾è¡¨å’Œ `map` å“ˆå¸Œè¡¨ï¼Œä¸‹é¢æˆ‘å…ˆæ¥å®ç° LRU ç®—æ³•çš„ `get` æ–¹æ³•ï¼š

```java
public int get(int key) {
    if (!map.containsKey(key)) {
        return -1;
    }
    // å°†è¯¥æ•°æ®æå‡ä¸ºæœ€è¿‘ä½¿ç”¨çš„
    makeRecently(key);
    return map.get(key).val;
}
```

`put` æ–¹æ³•ç¨å¾®å¤æ‚ä¸€äº›ï¼Œæˆ‘ä»¬å…ˆæ¥ç”»ä¸ªå›¾ææ¸…æ¥šå®ƒçš„é€»è¾‘ï¼š

<img src="assets/ca580eb634d27ec2a8f22714f741bbaf56c2b6d1.jpg" alt="img" style="zoom:50%;" />

è¿™æ ·æˆ‘ä»¬å¯ä»¥è½»æ¾å†™å‡º `put` æ–¹æ³•çš„ä»£ç ï¼š



```java
public void put(int key, int val) {
    if (map.containsKey(key)) {
        // åˆ é™¤æ—§çš„æ•°æ®
        deleteKey(key);
        // æ–°æ’å…¥çš„æ•°æ®ä¸ºæœ€è¿‘ä½¿ç”¨çš„æ•°æ®
        addRecently(key, val);
        return;
    }

    if (cap == cache.size()) {
        // åˆ é™¤æœ€ä¹…æœªä½¿ç”¨çš„å…ƒç´ 
        removeLeastRecently();
    }
    // æ·»åŠ ä¸ºæœ€è¿‘ä½¿ç”¨çš„å…ƒç´ 
    addRecently(key, val);
}
```

è‡³æ­¤ï¼Œä½ åº”è¯¥å·²ç»å®Œå…¨æŒæ¡ LRU ç®—æ³•çš„åŸç†å’Œå®ç°äº†ï¼Œæˆ‘ä»¬æœ€åç”¨ Java çš„å†…ç½®ç±»å‹ `LinkedHashMap` æ¥å®ç° LRU ç®—æ³•ï¼Œé€»è¾‘å’Œä¹‹å‰å®Œå…¨ä¸€è‡´ï¼Œæˆ‘å°±ä¸è¿‡å¤šè§£é‡Šäº†ï¼š

##### äºŒã€`HashMap+LinkedList`

```java
class Node {
    int key;
    int value;

    public Node(int key, int value) {
        this.key = key;
        this.value = value;
    }
}

class LRUCache {
    // key -> Node(key, val)
    private HashMap<Integer, Node> map;
    // Node(k1, v1) <-> Node(k2, v2)...
    private LinkedList<Node> cache;
    // æœ€å¤§å®¹é‡
    private int cap;

    public LRUCache(int capacity) {
        this.cap = capacity;
        map = new HashMap<>();
        cache = new LinkedList<>();
    }

    public int get(int key) {
        if (!map.containsKey(key)) {
            return -1;
        }
        // å°†è¯¥æ•°æ®æå‡ä¸ºæœ€è¿‘ä½¿ç”¨çš„
        makeRecently(key);
        return map.get(key).value;
    }

    public void put(int key, int val) {
        if (map.containsKey(key)) {
            // åˆ é™¤æ—§çš„æ•°æ®
            deleteKey(key);
            // æ–°æ’å…¥çš„æ•°æ®ä¸ºæœ€è¿‘ä½¿ç”¨çš„æ•°æ®
            addRecently(key, val);
            return;
        }

        if (cap == cache.size()) {
            // åˆ é™¤æœ€ä¹…æœªä½¿ç”¨çš„å…ƒç´ 
            removeLeastRecently();
        }
        // æ·»åŠ ä¸ºæœ€è¿‘ä½¿ç”¨çš„å…ƒç´ 
        addRecently(key, val);
    }

    /* å°†æŸä¸ª key æå‡ä¸ºæœ€è¿‘ä½¿ç”¨çš„ */
    private void makeRecently(int key) {
        Node x = map.get(key);
        // å…ˆä»é“¾è¡¨ä¸­åˆ é™¤è¿™ä¸ªèŠ‚ç‚¹
        cache.remove(x);
        // é‡æ–°æ’åˆ°é˜Ÿå°¾
        cache.addLast(x);
    }

    /* æ·»åŠ æœ€è¿‘ä½¿ç”¨çš„å…ƒç´  */
    private void addRecently(int key, int val) {
        Node x = new Node(key, val);
        // é“¾è¡¨å°¾éƒ¨å°±æ˜¯æœ€è¿‘ä½¿ç”¨çš„å…ƒç´ 
        cache.addLast(x);
        // åˆ«å¿˜äº†åœ¨ map ä¸­æ·»åŠ  key çš„æ˜ å°„
        map.put(key, x);
    }

    /* åˆ é™¤æŸä¸€ä¸ª key */
    private void deleteKey(int key) {
        Node x = map.get(key);
        // ä»é“¾è¡¨ä¸­åˆ é™¤
        cache.remove(x);
        // ä» map ä¸­åˆ é™¤
        map.remove(key);
    }

    /* åˆ é™¤æœ€ä¹…æœªä½¿ç”¨çš„å…ƒç´  */
    private void removeLeastRecently() {
        // é“¾è¡¨å¤´éƒ¨çš„ç¬¬ä¸€ä¸ªå…ƒç´ å°±æ˜¯æœ€ä¹…æœªä½¿ç”¨çš„
        Node deletedNode = cache.removeFirst();
        // åŒæ—¶åˆ«å¿˜äº†ä» map ä¸­åˆ é™¤å®ƒçš„ key
        int deletedKey = deletedNode.key;
        map.remove(deletedKey);
    }
}
```

##### ä¸‰ã€ä½¿ç”¨å†…ç½®ç±»å‹ `LinkedHashMap` æ¥å®ç° LRU ç®—æ³•

```java
class LRUCache {
    int cap;
    LinkedHashMap<Integer, Integer> cache = new LinkedHashMap<>();
    public LRUCache(int capacity) { 
        this.cap = capacity;
    }

    public int get(int key) {
        if (!cache.containsKey(key)) {
            return -1;
        }
        // å°† key å˜ä¸ºæœ€è¿‘ä½¿ç”¨
        makeRecently(key);
        return cache.get(key);
    }

    public void put(int key, int val) {
        if (cache.containsKey(key)) {
            // ä¿®æ”¹ key çš„å€¼
            cache.put(key, val);
            // å°† key å˜ä¸ºæœ€è¿‘ä½¿ç”¨
            makeRecently(key);
            return;
        }

        if (cache.size() >= this.cap) {
            // é“¾è¡¨å¤´éƒ¨å°±æ˜¯æœ€ä¹…æœªä½¿ç”¨çš„ key
            int oldestKey = cache.keySet().iterator().next();
            cache.remove(oldestKey);
        }
        // å°†æ–°çš„ key æ·»åŠ é“¾è¡¨å°¾éƒ¨
        cache.put(key, val);
    }

    private void makeRecently(int key) {
        int val = cache.get(key);
        // åˆ é™¤ keyï¼Œé‡æ–°æ’å…¥åˆ°é˜Ÿå°¾
        cache.remove(key);
        cache.put(key, val);
    }
}
```

#### [460. LFU ç¼“å­˜](https://leetcode-cn.com/problems/lfu-cache/)

![image-20210618163445158](assets/image-20210618163445158.png)

![image-20210618163504909](assets/image-20210618163504909.png)

LRU ç®—æ³•çš„æ·˜æ±°ç­–ç•¥æ˜¯ Least Recently Usedï¼Œä¹Ÿå°±æ˜¯æ¯æ¬¡æ·˜æ±°é‚£äº›æœ€ä¹…æ²¡è¢«ä½¿ç”¨çš„æ•°æ®ï¼›è€Œ LFU ç®—æ³•çš„æ·˜æ±°ç­–ç•¥æ˜¯ Least Frequently Usedï¼Œ LFU ç®—æ³•æ˜¯æ·˜æ±°è®¿é—®é¢‘æ¬¡æœ€ä½çš„æ•°æ®ï¼Œå¦‚æœè®¿é—®é¢‘æ¬¡æœ€ä½çš„æ•°æ®æœ‰å¤šæ¡ï¼Œéœ€è¦æ·˜æ±°æœ€æ—§çš„æ•°æ®ã€‚

LRU ç®—æ³•çš„æ ¸å¿ƒæ•°æ®ç»“æ„æ˜¯ä½¿ç”¨å“ˆå¸Œé“¾è¡¨ `LinkedHashMap`ï¼Œé¦–å…ˆå€ŸåŠ©é“¾è¡¨çš„æœ‰åºæ€§ä½¿å¾—é“¾è¡¨å…ƒç´ ç»´æŒæ’å…¥é¡ºåºï¼ŒåŒæ—¶å€ŸåŠ©å“ˆå¸Œæ˜ å°„çš„å¿«é€Ÿè®¿é—®èƒ½åŠ›ä½¿å¾—æˆ‘ä»¬å¯ä»¥åœ¨ O(1) æ—¶é—´è®¿é—®é“¾è¡¨çš„ä»»æ„å…ƒç´ ã€‚

https://mp.weixin.qq.com/s/oXv03m1J8TwtHwMJEZ1ApQ



##### ä¸€ã€O(1)è§£æ³•

ä¸‹é¢è¦è¯´çš„ O(1)O(1) çš„ 3 ç§ Java å†™æ³•å…¶å®æ˜¯ 1 ç§è§£æ³•ï¼Œå› ä¸ºå…·ä½“å®ç°ç»†èŠ‚ä¸­ä½¿ç”¨çš„æ•°æ®ç»“æ„ä¸åŒï¼Œå¯¼è‡´æ€§èƒ½æœ‰æ‰€å·®å¼‚ã€‚ä¸ºæ–¹ä¾¿ç†è§£ï¼Œä¸‹é¢ 3 ä¸ªå®ç°ï¼Œæ€§èƒ½ä»ç•¥æŒ«é€æ­¥ä¼˜åŒ–ï¼š

1.O(1) è§£æ³• â€”â€” åŒå‘é“¾è¡¨ç›´æ¥ä½¿ç”¨LinkedList

```python
HashMap<Integer, Node> cache å­˜ç¼“å­˜çš„å†…å®¹;
min æ˜¯æœ€å°è®¿é—®é¢‘æ¬¡;
HashMap<Integer, LinkedList<Node>> freqMap å­˜æ¯ä¸ªè®¿é—®é¢‘æ¬¡å¯¹åº”çš„ Node çš„åŒå‘é“¾è¡¨ï¼ˆå†™æ³• 1 ä¸ºäº†æ–¹ä¾¿ï¼Œç›´æ¥ç”¨äº† JDK ç°æœ‰çš„ LinkedListï¼‰
```

2.O(1) è§£æ³• â€”â€” è‡ªå®šä¹‰åŒå‘é“¾è¡¨

```python
HashMap<Integer, Node> cache å­˜ç¼“å­˜çš„å†…å®¹;
min æ˜¯æœ€å°è®¿é—®é¢‘æ¬¡;
HashMap<Integer, DoublyLinkedList>freqMap å­˜æ¯ä¸ªè®¿é—®é¢‘æ¬¡å¯¹åº”çš„ Node çš„åŒå‘é“¾è¡¨ï¼ˆå†™æ³• 2 ä¸å†™æ³• 1 ä¸€æ ·ï¼Œåªä¸è¿‡å°† JDK è‡ªå¸¦çš„ LinkedHashSet åŒå‘é“¾è¡¨å®ç°æ”¹æˆäº†è‡ªå®šä¹‰çš„åŒå‘é“¾è¡¨ DoublyLinkedListï¼Œå‡å°‘äº†ä¸€äº›å“ˆå¸Œç›¸å…³çš„è€—æ—¶ï¼‰
```

3.O(1) è§£æ³• â€”â€” å­˜å‚¨é¢‘æ¬¡çš„HashMapæ”¹ä¸ºç›´æ¥ç”¨åŒå‘é“¾è¡¨

```java
HashMap<Integer, Node> cache å­˜ç¼“å­˜çš„å†…å®¹; å°†å†™æ³• 1 å†™æ³• 2 ä¸­çš„ freqMap ä¸å†ç”¨ HashMap æ¥è¡¨ç¤ºï¼Œè€Œæ˜¯ç›´æ¥ç”¨åŒå‘é“¾è¡¨
DoublyLinkedList firstLinkedList; DoublyLinkedList lastLinkedListï¼Œçœå»äº†ä¸€äº›å“ˆå¸Œç›¸å…³çš„è€—æ—¶ï¼Œä¹Ÿä¸éœ€è¦ç”¨ min æ¥å­˜å‚¨æœ€å°é¢‘æ¬¡äº†ï¼ŒlastLinkedList.pre è¿™æ¡ DoublyLinkedList å³ä¸ºæœ€å°é¢‘æ¬¡å¯¹åº”çš„ Node åŒå‘é“¾è¡¨ï¼Œ
lastLinkedList.pre.tail.pre è¿™ä¸ª Node å³ä¸ºæœ€å°é¢‘æ¬¡çš„åŒå‘é“¾è¡¨ä¸­çš„æ‰€æœ‰ Node ä¸­æœ€å…ˆè®¿é—®çš„ Nodeï¼Œå³å®¹é‡æ»¡äº†åè¦åˆ é™¤çš„ Nodeã€‚
```

ä¸‹é¢è´´è¿™ä»¨å®ç°ï¼Œä¸å¤šå“”å“”äº†ç›´æ¥åœ¨ä»£ç ä¸­æ³¨é‡Šå•¦
æœ€ä¼˜è§£æ˜¯ç¬¬ä¸‰ç§ï¼Œè¯¦å°½æ³¨é‡Šäº†ã€‚ å…¶ä»–çš„å®ç°å®åœ¨æ‡’å¾—æ³¨é‡Šäº†å“ğŸ¥ºï¼Œæ²¡æ³•æŠ˜å å¥½å‚»xï¼Œç›´æ¥è·³å»ç¬¬ä¸‰ç§å­

###### O(1) è§£æ³• â€”â€” åŒå‘é“¾è¡¨ç›´æ¥ä½¿ç”¨LinkedList

```java
class Node {
    int key;
    int value;
    int freq = 1;

    public Node() {
    }

    public Node(int key, int value) {
        this.key = key;
        this.value = value;
    }
}

class LFUCache {
    Map<Integer, Node> cache; // å­˜å‚¨ç¼“å­˜çš„å†…å®¹
    Map<Integer, LinkedList<Node>> freqMap; // å­˜å‚¨æ¯ä¸ªé¢‘æ¬¡å¯¹åº”çš„åŒå‘é“¾è¡¨
    int size;
    int capacity;
    int min; // å­˜å‚¨å½“å‰æœ€å°é¢‘æ¬¡

    public LFUCache(int capacity) {
        cache = new HashMap<>(capacity);
        freqMap = new HashMap<>();
        this.capacity = capacity;
    }

    public int get(int key) {
        Node node = cache.get(key);
        if (node == null) {
            return -1;
        }
        increaseFreq(node);
        return node.value;
    }

    public void put(int key, int value) {
        if (capacity == 0) {
            return;
        }
        Node node = cache.get(key);
        if (node != null) {
            node.value = value;
            increaseFreq(node);
        } else {
            if (size == capacity) {
                Node deadNode = removeNode();
                cache.remove(deadNode.key);
                size--;
            }
            Node newNode = new Node(key, value);
            cache.put(key, newNode);
            addNode(newNode);
            size++;
        }
    }

    void increaseFreq(Node node) {
        // ä»åŸfreqå¯¹åº”çš„é“¾è¡¨é‡Œç§»é™¤, å¹¶æ›´æ–°min
        int freq = node.freq;
        LinkedList<Node> linkedList = freqMap.get(freq);
        linkedList.remove(node);
        if (freq == min && linkedList.size() == 0) {
            min = freq + 1;
        }
        // åŠ å…¥æ–°freqå¯¹åº”çš„é“¾è¡¨
        node.freq++;
        LinkedList<Node> newList = freqMap.get(freq + 1);
        if (newList == null) {
            newList = new LinkedList<>();
            freqMap.put(freq + 1, newList);
        }
        newList.offerLast(node);
    }

    void addNode(Node node) {
        LinkedList<Node> linkedList = freqMap.get(1);
        if (linkedList == null) {
            linkedList = new LinkedList<>();
            freqMap.put(1, linkedList);
        }
        linkedList.offerLast(node);
        min = 1;
    }

    Node removeNode() {
        LinkedList<Node> linkedList = freqMap.get(min);
        Node deadNode = linkedList.pollFirst();
        return deadNode;
        // æ²¡å¿…è¦æ›´æ–°minå˜é‡,å› ä¸ºè¯¥å‡½æ•°æ‰§è¡Œå®Œæ¯•ä¸€å®šä¼šæ’å…¥Nodeï¼Œminä¼šæ›´æ–°ä¸º1
    }
}

```

###### O(1) è§£æ³• â€”â€” è‡ªå®šä¹‰åŒå‘é“¾è¡¨

```java
class LFUCache {
    Map<Integer, Node> cache; // å­˜å‚¨ç¼“å­˜çš„å†…å®¹
    Map<Integer, DoublyLinkedList> freqMap; // å­˜å‚¨æ¯ä¸ªé¢‘æ¬¡å¯¹åº”çš„åŒå‘é“¾è¡¨
    int size;
    int capacity;
    int min; // å­˜å‚¨å½“å‰æœ€å°é¢‘æ¬¡

    public LFUCache(int capacity) {
        cache = new HashMap<> (capacity);
        freqMap = new HashMap<>();
        this.capacity = capacity;
    }
    
    public int get(int key) {
        Node node = cache.get(key);
        if (node == null) {
            return -1;
        }
        freqInc(node);
        return node.value;
    }
    
    public void put(int key, int value) {
        if (capacity == 0) {
            return;
        }
        Node node = cache.get(key);
        if (node != null) {
            node.value = value;
            freqInc(node);
        } else {
            if (size == capacity) {
                DoublyLinkedList minFreqLinkedList = freqMap.get(min);
                cache.remove(minFreqLinkedList.tail.pre.key);
                minFreqLinkedList.removeNode(minFreqLinkedList.tail.pre); // è¿™é‡Œä¸éœ€è¦ç»´æŠ¤min, å› ä¸ºä¸‹é¢addäº†newNodeåminè‚¯å®šæ˜¯1.
                size--;
            }
            Node newNode = new Node(key, value);
            cache.put(key, newNode);
            DoublyLinkedList linkedList = freqMap.get(1);
            if (linkedList == null) {
                linkedList = new DoublyLinkedList();
                freqMap.put(1, linkedList);
            }
            linkedList.addNode(newNode);
            size++;  
            min = 1;   
        }
    }

    void freqInc(Node node) {
        // ä»åŸfreqå¯¹åº”çš„é“¾è¡¨é‡Œç§»é™¤, å¹¶æ›´æ–°min
        int freq = node.freq;
        DoublyLinkedList linkedList = freqMap.get(freq);
        linkedList.removeNode(node);
        if (freq == min && linkedList.head.post == linkedList.tail) { 
            min = freq + 1;
        }
        // åŠ å…¥æ–°freqå¯¹åº”çš„é“¾è¡¨
        node.freq++;
        linkedList = freqMap.get(freq + 1);
        if (linkedList == null) {
            linkedList = new DoublyLinkedList();
            freqMap.put(freq + 1, linkedList);
        }
        linkedList.addNode(node);
    }
}

class Node {
    int key;
    int value;
    int freq = 1;
    Node pre;
    Node post;

    public Node() {}
    
    public Node(int key, int value) {
        this.key = key;
        this.value = value;
    }
}

class DoublyLinkedList {
    Node head;
    Node tail;

    public DoublyLinkedList() {
        head = new Node();
        tail = new Node();
        head.post = tail;
        tail.pre = head;
    }

    void removeNode(Node node) {
        node.pre.post = node.post;
        node.post.pre = node.pre;
    }

    void addNode(Node node) {
        node.post = head.post;
        head.post.pre = node;
        head.post = node;
        node.pre = head;
    }
}

ä½œè€…ï¼šsweetiee
é“¾æ¥ï¼šhttps://leetcode-cn.com/problems/lfu-cache/solution/java-13ms-shuang-100-shuang-xiang-lian-biao-duo-ji/
æ¥æºï¼šåŠ›æ‰£ï¼ˆLeetCodeï¼‰
è‘—ä½œæƒå½’ä½œè€…æ‰€æœ‰ã€‚å•†ä¸šè½¬è½½è¯·è”ç³»ä½œè€…è·å¾—æˆæƒï¼Œéå•†ä¸šè½¬è½½è¯·æ³¨æ˜å‡ºå¤„ã€‚
```

###### O(1) è§£æ³• â€”â€” å­˜å‚¨é¢‘æ¬¡çš„HashMapæ”¹ä¸ºç›´æ¥ç”¨åŒå‘é“¾è¡¨ï¼ˆæœ€ä¼˜å®ç° 13ms åŒ100%ï¼‰

```java
class LFUCache {
    Map<Integer, Node> cache; // å­˜å‚¨ç¼“å­˜çš„å†…å®¹ï¼ŒNodeä¸­é™¤äº†valueå€¼å¤–ï¼Œè¿˜æœ‰keyã€freqã€æ‰€åœ¨doublyLinkedListã€æ‰€åœ¨doublyLinkedListä¸­çš„postNodeã€æ‰€åœ¨doublyLinkedListä¸­çš„preNodeï¼Œå…·ä½“å®šä¹‰åœ¨ä¸‹æ–¹ã€‚
    DoublyLinkedList firstLinkedList; // firstLinkedList.post æ˜¯é¢‘æ¬¡æœ€å¤§çš„åŒå‘é“¾è¡¨
    DoublyLinkedList lastLinkedList; // lastLinkedList.pre æ˜¯é¢‘æ¬¡æœ€å°çš„åŒå‘é“¾è¡¨ï¼Œæ»¡äº†ä¹‹ååˆ é™¤ lastLinkedList.pre.tail.pre
                                     // è¿™ä¸ªNodeå³ä¸ºé¢‘æ¬¡æœ€å°ä¸”è®¿é—®æœ€æ—©çš„Node
    int size;
    int capacity;

    public LFUCache(int capacity) {
        cache = new HashMap<>(capacity);
        firstLinkedList = new DoublyLinkedList();
        lastLinkedList = new DoublyLinkedList();
        firstLinkedList.post = lastLinkedList;
        lastLinkedList.pre = firstLinkedList;
        this.capacity = capacity;
    }

    public int get(int key) {
        Node node = cache.get(key);
        if (node == null) {
            return -1;
        }
        // è¯¥keyè®¿é—®é¢‘æ¬¡+1
        freqInc(node);
        return node.value;
    }

    public void put(int key, int value) {
        if (capacity == 0) {
            return;
        }
        Node node = cache.get(key);
        // è‹¥keyå­˜åœ¨ï¼Œåˆ™æ›´æ–°valueï¼Œè®¿é—®é¢‘æ¬¡+1
        if (node != null) {
            node.value = value;
            freqInc(node);
        } else {
            // è‹¥keyä¸å­˜åœ¨
            if (size == capacity) {
                // å¦‚æœç¼“å­˜æ»¡äº†ï¼Œåˆ é™¤lastLinkedList.preè¿™ä¸ªé“¾è¡¨ï¼ˆå³è¡¨ç¤ºæœ€å°é¢‘æ¬¡çš„é“¾è¡¨ï¼‰ä¸­çš„tail.preè¿™ä¸ªNodeï¼ˆå³æœ€å°é¢‘æ¬¡é“¾è¡¨ä¸­æœ€å…ˆè®¿é—®çš„Nodeï¼‰ï¼Œå¦‚æœè¯¥é“¾è¡¨ä¸­çš„å…ƒç´ åˆ ç©ºäº†ï¼Œåˆ™åˆ æ‰è¯¥é“¾è¡¨ã€‚
                cache.remove(lastLinkedList.pre.tail.pre.key);
                lastLinkedList.removeNode(lastLinkedList.pre.tail.pre);
                size--;
                if (lastLinkedList.pre.head.post == lastLinkedList.pre.tail) {
                    removeDoublyLinkedList(lastLinkedList.pre);
                }
            }
            // cacheä¸­putæ–°Key-Nodeå¯¹å„¿ï¼Œå¹¶å°†æ–°nodeåŠ å…¥è¡¨ç¤ºfreqä¸º1çš„DoublyLinkedListä¸­ï¼Œè‹¥ä¸å­˜åœ¨freqä¸º1çš„DoublyLinkedListåˆ™æ–°å»ºã€‚
            Node newNode = new Node(key, value);
            cache.put(key, newNode);
            if (lastLinkedList.pre.freq != 1) {
                DoublyLinkedList newDoublyLinedList = new DoublyLinkedList(1);
                addDoublyLinkedList(newDoublyLinedList, lastLinkedList.pre);
                newDoublyLinedList.addNode(newNode);
            } else {
                lastLinkedList.pre.addNode(newNode);
            }
            size++;
        }
    }

    // nodeçš„è®¿é—®é¢‘æ¬¡ + 1

    void freqInc(Node node) {
        // å°†nodeä»åŸfreqå¯¹åº”çš„åŒå‘é“¾è¡¨é‡Œç§»é™¤, å¦‚æœé“¾è¡¨ç©ºäº†åˆ™åˆ é™¤é“¾è¡¨ã€‚
        DoublyLinkedList linkedList = node.doublyLinkedList;
        DoublyLinkedList preLinkedList = linkedList.pre;
        linkedList.removeNode(node);
        if (linkedList.head.post == linkedList.tail) {
            removeDoublyLinkedList(linkedList);
        }
        // å°†nodeåŠ å…¥æ–°freqå¯¹åº”çš„åŒå‘é“¾è¡¨ï¼Œè‹¥è¯¥é“¾è¡¨ä¸å­˜åœ¨ï¼Œåˆ™å…ˆåˆ›å»ºè¯¥é“¾è¡¨ã€‚
        node.freq++;
        if (preLinkedList.freq != node.freq) {
            DoublyLinkedList newDoublyLinedList = new DoublyLinkedList(node.freq);
            addDoublyLinkedList(newDoublyLinedList, preLinkedList);
            newDoublyLinedList.addNode(node);
        } else {
            preLinkedList.addNode(node);
        }
    }

    /**
     * å¢åŠ ä»£è¡¨æŸ1é¢‘æ¬¡çš„åŒå‘é“¾è¡¨
     */
    void addDoublyLinkedList(DoublyLinkedList newDoublyLinedList, DoublyLinkedList preLinkedList) {
        newDoublyLinedList.post = preLinkedList.post;
        newDoublyLinedList.post.pre = newDoublyLinedList;
        newDoublyLinedList.pre = preLinkedList;
        preLinkedList.post = newDoublyLinedList;
    }

    /**
     * åˆ é™¤ä»£è¡¨æŸ1é¢‘æ¬¡çš„åŒå‘é“¾è¡¨
     */
    void removeDoublyLinkedList(DoublyLinkedList doublyLinkedList) {
        doublyLinkedList.pre.post = doublyLinkedList.post;
        doublyLinkedList.post.pre = doublyLinkedList.pre;
    }
}

class Node {
    int key;
    int value;
    int freq = 1;
    Node pre; // Nodeæ‰€åœ¨é¢‘æ¬¡çš„åŒå‘é“¾è¡¨çš„å‰ç»§Node
    Node post; // Nodeæ‰€åœ¨é¢‘æ¬¡çš„åŒå‘é“¾è¡¨çš„åç»§Node
    DoublyLinkedList doublyLinkedList; // Nodeæ‰€åœ¨é¢‘æ¬¡çš„åŒå‘é“¾è¡¨

    public Node() {
    }

    public Node(int key, int value) {
        this.key = key;
        this.value = value;
    }
}

class DoublyLinkedList {
    int freq; // è¯¥åŒå‘é“¾è¡¨è¡¨ç¤ºçš„é¢‘æ¬¡
    DoublyLinkedList pre; // è¯¥åŒå‘é“¾è¡¨çš„å‰ç»§é“¾è¡¨ï¼ˆpre.freq < this.freqï¼‰
    DoublyLinkedList post; // è¯¥åŒå‘é“¾è¡¨çš„åç»§é“¾è¡¨ (post.freq > this.freq)
    Node head; // è¯¥åŒå‘é“¾è¡¨çš„å¤´èŠ‚ç‚¹ï¼Œæ–°èŠ‚ç‚¹ä»å¤´éƒ¨åŠ å…¥ï¼Œè¡¨ç¤ºæœ€è¿‘è®¿é—®
    Node tail; // è¯¥åŒå‘é“¾è¡¨çš„å°¾èŠ‚ç‚¹ï¼Œåˆ é™¤èŠ‚ç‚¹ä»å°¾éƒ¨åˆ é™¤ï¼Œè¡¨ç¤ºæœ€ä¹…è®¿é—®

    public DoublyLinkedList() {
        head = new Node();
        tail = new Node();
        head.post = tail;
        tail.pre = head;
    }

    public DoublyLinkedList(int freq) {
        head = new Node();
        tail = new Node();
        head.post = tail;
        tail.pre = head;
        this.freq = freq;
    }

    void removeNode(Node node) {
        node.pre.post = node.post;
        node.post.pre = node.pre;
    }

    void addNode(Node node) {
        node.post = head.post;
        head.post.pre = node;
        head.post = node;
        node.pre = head;
        node.doublyLinkedList = this;
    }
}
```

##### äºŒã€O(logN)O(logN) è§£æ³•

O(logN) è§£æ³• â€”â€” ä½¿ç”¨å°æ ¹å †æ‰¾åˆ° freq æœ€å°ï¼Œå› ä¸º Java ä¸­çš„ PriorityQueue é»˜è®¤å°±æ˜¯å°æ ¹å †, å®ç°æœ€ç®€å•
æ¯æ¬¡å°†è®¿é—®é¢‘æ¬¡ freq æœ€å°çš„ä¸”æœ€å…ˆè®¿é—®çš„ä¸Šæµ®åˆ°å †é¡¶ï¼Œä¸‹é¢ç”¨å…¨å±€è‡ªå¢ idx è¡¨ç¤ºè®¿é—®çš„å…ˆåï¼Œæˆ–è€…å¯ä»¥ç›´æ¥æ”¹æˆ idx = System.nanoTime() ç”¨ä»¥æ¯”è¾ƒè®¿é—®æ—¶é—´çš„å…ˆåã€‚

```java
class LFUCache {

    Map<Integer, Node> cache;
    Queue<Node> queue;
    int capacity;
    int size;
    int idx = 0;

    public LFUCache(int capacity) {
        cache = new HashMap<>(capacity);
        if (capacity > 0) {
            queue = new PriorityQueue<>(capacity);
        }
        this.capacity = capacity;
    }
    
    public int get(int key) {
        Node node = cache.get(key);
        if (node == null) {
            return -1;
        }
        node.freq++;
        node.idx = idx++;
        queue.remove(node);
        queue.offer(node);
        return node.value;

    }
    
    public void put(int key, int value) {
        if (capacity == 0) {
            return;
        }
        Node node = cache.get(key);
        if (node != null) {
            node.value = value;
            node.freq++;
            node.idx = idx++;
            queue.remove(node);
            queue.offer(node);
        } else {
            if (size == capacity) {
                cache.remove(queue.peek().key);
                queue.poll();
                size--;
            } 
            Node newNode = new Node(key, value, idx++);
            cache.put(key, newNode);
            queue.offer(newNode);
            size++;
        }
    }
}

class Node implements Comparable<Node> {
    int key;
    int value;
    int freq;
    int idx;

    public Node() {}

    public Node(int key, int value, int idx) {
        this.key = key;
        this.value = value;
        freq = 1;
        this.idx = idx;
    }

    public int compareTo(Node node) {
		int diff = freq - node.freq;
        return diff != 0? diff: idx - node.idx;
    }
}

ä½œè€…ï¼šsweetiee
é“¾æ¥ï¼šhttps://leetcode-cn.com/problems/lfu-cache/solution/java-13ms-shuang-100-shuang-xiang-lian-biao-duo-ji/
æ¥æºï¼šåŠ›æ‰£ï¼ˆLeetCodeï¼‰
è‘—ä½œæƒå½’ä½œè€…æ‰€æœ‰ã€‚å•†ä¸šè½¬è½½è¯·è”ç³»ä½œè€…è·å¾—æˆæƒï¼Œéå•†ä¸šè½¬è½½è¯·æ³¨æ˜å‡ºå¤„ã€‚
```

##### ä¸‰ã€O(N) è§£æ³•

æœ€å‚»fufuã® O(N) â€”â€” åªç”¨1æ¡åŒå‘é“¾è¡¨
ä½¿ freq å°çš„ Node åœ¨é“¾è¡¨çš„å·¦è¾¹ï¼Œfreq å¤§çš„ Node åœ¨é“¾è¡¨çš„å³è¾¹ï¼Œfreq ç›¸ç­‰çš„è¯æœ€ä¹…ä½¿ç”¨çš„ Node åœ¨å·¦è¾¹ã€æœ€è¿‘ä½¿ç”¨çš„ Node åœ¨å³è¾¹ï¼Œå› æ­¤æ»¡äº†ä¹‹ååˆ é™¤ head.postï¼Œè¯¥ Node å³ freq æœ€å°ä¸”æœ€ä¹…è®¿é—®çš„ã€‚
æ¯æ¬¡ node çš„ freq++ åï¼Œä»å½“å‰ä½ç½®å‘åéå†é“¾è¡¨ï¼Œç›´åˆ° nextNode.freq > node.freq || nextNode == tailï¼Œåœ¨ nextNode ä¹‹å‰æ’å…¥è¯¥ nodeã€‚

```java
class LFUCache {

    HashMap<Integer, Node> cache;
    Node head;
    Node tail;
    int capacity;
    int size;

    public LFUCache(int capacity) {
        cache = new HashMap<Integer, Node>(capacity);
        this.capacity = capacity;
        head = new Node();
        tail = new Node();
        head.post = tail;
        tail.pre = head;
    }
    
    public int get(int key) {
        Node node = cache.get(key);
        if (node == null) {
            return -1;
        }
        node.freq++;
        moveToNewPosition(node);
        return node.value;
    }
    
    public void put(int key, int value) {
        if (capacity == 0) {
            return;
        }
        Node node = cache.get(key);
        if (node != null) {
            node.value = value;
            node.freq++;
            moveToNewPosition(node);
        } else {
            if (size == capacity) {
                cache.remove(head.post.key);
                removeNode(head.post);
                size--;
            }
            Node newNode = new Node(key, value);
            addNode(newNode);
            cache.put(key, newNode);
            size++;
        }
    }

    private void moveToNewPosition(Node node) {
        Node nextNode = node.post;
        removeNode(node);
        while (nextNode.freq <= node.freq && nextNode != tail) {
            nextNode = nextNode.post;
        }
        nextNode.pre.post = node;
        node.pre = nextNode.pre;
        node.post = nextNode;
        nextNode.pre = node;
    }

    private void addNode(Node node) {
        node.post = head.post;
        node.pre = head;
        head.post.pre = node;
        head.post = node;
        moveToNewPosition(node);
    }

    private void removeNode(Node node) {
        node.pre.post = node.post;
        node.post.pre = node.pre;
    }
}

class Node {
    int key;
    int value;
    int freq = 1;
    Node pre;
    Node post;

    public Node() {}
    public Node(int key, int value) {
        this.key = key;
        this.value = value;
    }
}

ä½œè€…ï¼šsweetiee
é“¾æ¥ï¼šhttps://leetcode-cn.com/problems/lfu-cache/solution/java-13ms-shuang-100-shuang-xiang-lian-biao-duo-ji/
æ¥æºï¼šåŠ›æ‰£ï¼ˆLeetCodeï¼‰
è‘—ä½œæƒå½’ä½œè€…æ‰€æœ‰ã€‚å•†ä¸šè½¬è½½è¯·è”ç³»ä½œè€…è·å¾—æˆæƒï¼Œéå•†ä¸šè½¬è½½è¯·æ³¨æ˜å‡ºå¤„ã€‚
```

#### [895. æœ€å¤§é¢‘ç‡æ ˆ](https://leetcode-cn.com/problems/maximum-frequency-stack/)

![image-20210621171818134](assets/image-20210621171818134.png)

**è¿™ç§è®¾è®¡æ•°æ®ç»“æ„çš„é—®é¢˜ï¼Œä¸»è¦æ˜¯è¦ææ¸…æ¥šé—®é¢˜çš„éš¾ç‚¹åœ¨å“ªé‡Œï¼Œç„¶åç»“åˆå„ç§åŸºæœ¬æ•°æ®ç»“æ„çš„ç‰¹æ€§ï¼Œé«˜æ•ˆå®ç°é¢˜ç›®è¦æ±‚çš„ API**ã€‚

é‚£ä¹ˆï¼Œæˆ‘ä»¬ä»”ç»†æ€è€ƒä¸€ä¸‹ `push` å’Œ `pop` æ–¹æ³•ï¼Œéš¾ç‚¹å¦‚ä¸‹ï¼š

1ã€æ¯æ¬¡ `pop` æ—¶ï¼Œå¿…é¡»è¦çŸ¥é“é¢‘ç‡æœ€é«˜çš„å…ƒç´ æ˜¯ä»€ä¹ˆã€‚

2ã€å¦‚æœé¢‘ç‡æœ€é«˜çš„å…ƒç´ æœ‰å¤šä¸ªï¼Œè¿˜å¾—çŸ¥é“å“ªä¸ªæ˜¯æœ€è¿‘ `push` è¿›æ¥çš„å…ƒç´ æ˜¯å“ªä¸ªã€‚



```java
class FreqStack {
    // è®°å½• FreqStack ä¸­å…ƒç´ çš„æœ€å¤§é¢‘ç‡
    int maxFreq = 0;
    // è®°å½• FreqStack ä¸­æ¯ä¸ª val å¯¹åº”çš„å‡ºç°é¢‘ç‡ï¼Œåæ–‡å°±ç§°ä¸º VF è¡¨
    HashMap<Integer, Integer> valToFreq = new HashMap<>();
    // è®°å½•é¢‘ç‡ freq å¯¹åº”çš„ val åˆ—è¡¨ï¼Œåæ–‡å°±ç§°ä¸º FV è¡¨
    HashMap<Integer, Stack<Integer>> freqToVals = new HashMap<>();
    
    public void push(int val) {
        // ä¿®æ”¹ VF è¡¨ï¼šval å¯¹åº”çš„ freq åŠ ä¸€
        int freq = valToFreq.getOrDefault(val, 0) + 1;
        valToFreq.put(val, freq);
        // ä¿®æ”¹ FV è¡¨ï¼šåœ¨ freq å¯¹åº”çš„åˆ—è¡¨åŠ ä¸Š val
        freqToVals.putIfAbsent(freq, new Stack<>());
        freqToVals.get(freq).push(val);
        // æ›´æ–° maxFreq
        maxFreq = Math.max(maxFreq, freq);
	}
    
    public int pop() {
        // ä¿®æ”¹ FV è¡¨ï¼špop å‡ºä¸€ä¸ª maxFreq å¯¹åº”çš„å…ƒç´  v
        Stack<Integer> vals = freqToVals.get(maxFreq);
        int v = vals.pop();
        // ä¿®æ”¹ VF è¡¨ï¼šv å¯¹åº”çš„ freq å‡ä¸€
        int freq = valToFreq.get(v) - 1;
        valToFreq.put(v, freq);
        // æ›´æ–° maxFreq
        if (vals.isEmpty()) {
            // å¦‚æœ maxFreq å¯¹åº”çš„å…ƒç´ ç©ºäº†
            maxFreq--;
        }
        return v;
    }
}
```

#### [295. æ•°æ®æµçš„ä¸­ä½æ•°](https://leetcode-cn.com/problems/find-median-from-data-stream/)

![image-20210621203326557](assets/image-20210621203326557.png)

**ä¸ä»…è¦ç»´æŠ¤ `large` å’Œ `small` çš„å…ƒç´ ä¸ªæ•°ä¹‹å·®ä¸è¶…è¿‡ 1ï¼Œè¿˜è¦ç»´æŠ¤ `large` å †çš„å †é¡¶å…ƒç´ è¦å¤§äºç­‰äº `small` å †çš„å †é¡¶å…ƒç´ **ã€‚



```java
class MedianFinder {

    private PriorityQueue<Integer> large;
    private PriorityQueue<Integer> small;
    
    public MedianFinder() {
        // å°é¡¶å †
        large = new PriorityQueue<>();
        // å¤§é¡¶å †
        small = new PriorityQueue<>((a, b) -> {
            return b - a;
        });
    }

    public double findMedian() {
        // å¦‚æœå…ƒç´ ä¸ä¸€æ ·å¤šï¼Œå¤šçš„é‚£ä¸ªå †çš„å †é¡¶å…ƒç´ å°±æ˜¯ä¸­ä½æ•°
        if (large.size() < small.size()) {
            return small.peek();
        } else if (large.size() > small.size()) {
            return large.peek();
        }
        // å¦‚æœå…ƒç´ ä¸€æ ·å¤šï¼Œä¸¤ä¸ªå †å †é¡¶å…ƒç´ çš„å¹³å‡æ•°æ˜¯ä¸­ä½æ•°
        return (large.peek() + small.peek()) / 2.0;
    }

    // æ­£ç¡®çš„ä»£ç å®ç°
    public void addNum(int num) {
        if (small.size() >= large.size()) {
            small.offer(num);
            large.offer(small.poll());
        } else {
            large.offer(num);
            small.offer(large.poll());
        }
    }
}
```

**ç®€å•è¯´ï¼Œæƒ³è¦å¾€ `large` é‡Œæ·»åŠ å…ƒç´ ï¼Œä¸èƒ½ç›´æ¥æ·»åŠ ï¼Œè€Œæ˜¯è¦å…ˆå¾€ `small` é‡Œæ·»åŠ ï¼Œç„¶åå†æŠŠ `small` çš„å †é¡¶å…ƒç´ åŠ åˆ° `large` ä¸­ï¼›å‘ `small` ä¸­æ·»åŠ å…ƒç´ åŒç†**ã€‚

ä¸ºä»€ä¹ˆå‘¢ï¼Œç¨åŠ æ€è€ƒå¯ä»¥æƒ³æ˜ç™½ï¼Œå‡è®¾æˆ‘ä»¬å‡†å¤‡å‘ `large` ä¸­æ’å…¥å…ƒç´ ï¼š

å¦‚æœæ’å…¥çš„ `num` å°äº `small` çš„å †é¡¶å…ƒç´ ï¼Œé‚£ä¹ˆ `num` å°±ä¼šç•™åœ¨ `small` å †é‡Œï¼Œä¸ºäº†ä¿è¯ä¸¤ä¸ªå †çš„å…ƒç´ æ•°é‡ä¹‹å·®ä¸å¤§äº 1ï¼Œä½œä¸ºäº¤æ¢ï¼ŒæŠŠ `small` å †é¡¶éƒ¨çš„å…ƒç´ å†æ’åˆ° `large` å †é‡Œã€‚

å¦‚æœæ’å…¥çš„ `num` å¤§äº `small` çš„å †é¡¶å…ƒç´ ï¼Œé‚£ä¹ˆ `num` å°±ä¼šæˆä¸º `samll` çš„å †é¡¶å…ƒç´ ï¼Œæœ€åè¿˜æ˜¯ä¼šè¢«æ’å…¥ `large` å †ä¸­ã€‚

åä¹‹ï¼Œå‘ `small` ä¸­æ’å…¥å…ƒç´ æ˜¯ä¸€ä¸ªé“ç†ï¼Œè¿™æ ·å°±å·§å¦™åœ°ä¿è¯äº† `large` å †æ•´ä½“å¤§äº `small` å †ï¼Œä¸”ä¸¤ä¸ªå †çš„å…ƒç´ ä¹‹å·®ä¸è¶…è¿‡ 1ï¼Œé‚£ä¹ˆä¸­ä½æ•°å°±å¯ä»¥é€šè¿‡ä¸¤ä¸ªå †çš„å †é¡¶å…ƒç´ å¿«é€Ÿè®¡ç®—äº†ã€‚

è‡³æ­¤ï¼Œæ•´ä¸ªç®—æ³•å°±ç»“æŸäº†ï¼Œ`addNum` æ–¹æ³•æ—¶é—´å¤æ‚åº¦ O(logN)ï¼Œ`findMedian` æ–¹æ³•æ—¶é—´å¤æ‚åº¦ O(1)ã€‚

#### [355. è®¾è®¡æ¨ç‰¹](https://leetcode-cn.com/problems/design-twitter/)

![image-20210622101640323](assets/image-20210622101640323.png)



è¿™å‡ ä¸ª API ä¸­å¤§éƒ¨åˆ†éƒ½å¾ˆå¥½å®ç°ï¼Œæœ€æ ¸å¿ƒçš„åŠŸèƒ½éš¾ç‚¹åº”è¯¥æ˜¯ `getNewsFeed`ï¼Œå› ä¸ºè¿”å›çš„ç»“æœå¿…é¡»åœ¨æ—¶é—´ä¸Šæœ‰åºï¼Œä½†é—®é¢˜æ˜¯ç”¨æˆ·çš„å…³æ³¨æ˜¯åŠ¨æ€å˜åŒ–çš„ï¼Œæ€ä¹ˆåŠï¼Ÿ

**è¿™é‡Œå°±æ¶‰åŠåˆ°ç®—æ³•äº†**ï¼šå¦‚æœæˆ‘ä»¬æŠŠæ¯ä¸ªç”¨æˆ·å„è‡ªçš„æ¨æ–‡å­˜å‚¨åœ¨é“¾è¡¨é‡Œï¼Œæ¯ä¸ªé“¾è¡¨èŠ‚ç‚¹å­˜å‚¨æ–‡ç«  id å’Œä¸€ä¸ªæ—¶é—´æˆ³ timeï¼ˆè®°å½•å‘å¸–æ—¶é—´ä»¥ä¾¿æ¯”è¾ƒï¼‰ï¼Œè€Œä¸”è¿™ä¸ªé“¾è¡¨æ˜¯æŒ‰ time æœ‰åºçš„ï¼Œé‚£ä¹ˆå¦‚æœæŸä¸ªç”¨æˆ·å…³æ³¨äº† k ä¸ªç”¨æˆ·ï¼Œæˆ‘ä»¬å°±å¯ä»¥ç”¨åˆå¹¶ k ä¸ªæœ‰åºé“¾è¡¨çš„ç®—æ³•åˆå¹¶å‡ºæœ‰åºçš„æ¨æ–‡åˆ—è¡¨ï¼Œæ­£ç¡®åœ° `getNewsFeed` äº†ï¼

ä¹‹æ‰€ä»¥è¦æŠŠ Tweet å’Œ User ç±»æ”¾åˆ° Twitter ç±»é‡Œé¢ï¼Œæ˜¯å› ä¸º Tweet ç±»å¿…é¡»è¦ç”¨åˆ°ä¸€ä¸ªå…¨å±€æ—¶é—´æˆ³ timestampï¼Œè€Œ User ç±»åˆéœ€è¦ç”¨åˆ° Tweet ç±»è®°å½•ç”¨æˆ·å‘é€çš„æ¨æ–‡ï¼Œæ‰€ä»¥å®ƒä»¬éƒ½ä½œä¸ºå†…éƒ¨ç±»ã€‚

**1ã€Tweet ç±»çš„å®ç°**

Tweet ç±»å¾ˆå®¹æ˜“å®ç°ï¼šæ¯ä¸ª Tweet å®ä¾‹éœ€è¦è®°å½•è‡ªå·±çš„ tweetId å’Œå‘è¡¨æ—¶é—´ timeï¼Œè€Œä¸”ä½œä¸ºé“¾è¡¨èŠ‚ç‚¹ï¼Œè¦æœ‰ä¸€ä¸ªæŒ‡å‘ä¸‹ä¸€ä¸ªèŠ‚ç‚¹çš„ next æŒ‡é’ˆã€‚

```java
class Tweet {
    private int id;
    private int time;
    private Tweet next;

    // éœ€è¦ä¼ å…¥æ¨æ–‡å†…å®¹ï¼ˆidï¼‰å’Œå‘æ–‡æ—¶é—´
    public Tweet(int id, int time) {
        this.id = id;
        this.time = time;
        this.next = null;
    }
}
```



**2ã€User ç±»çš„å®ç°**

æˆ‘ä»¬æ ¹æ®å®é™…åœºæ™¯æƒ³ä¸€æƒ³ï¼Œä¸€ä¸ªç”¨æˆ·éœ€è¦å­˜å‚¨çš„ä¿¡æ¯æœ‰ userIdï¼Œå…³æ³¨åˆ—è¡¨ï¼Œä»¥åŠè¯¥ç”¨æˆ·å‘è¿‡çš„æ¨æ–‡åˆ—è¡¨ã€‚å…¶ä¸­å…³æ³¨åˆ—è¡¨åº”è¯¥ç”¨é›†åˆï¼ˆHash Setï¼‰è¿™ç§æ•°æ®ç»“æ„æ¥å­˜ï¼Œå› ä¸ºä¸èƒ½é‡å¤ï¼Œè€Œä¸”éœ€è¦å¿«é€ŸæŸ¥æ‰¾ï¼›æ¨æ–‡åˆ—è¡¨åº”è¯¥ç”±é“¾è¡¨è¿™ç§æ•°æ®ç»“æ„å‚¨å­˜ï¼Œä»¥ä¾¿äºè¿›è¡Œæœ‰åºåˆå¹¶çš„æ“ä½œã€‚

é™¤æ­¤ä¹‹å¤–ï¼Œæ ¹æ®é¢å‘å¯¹è±¡çš„è®¾è®¡åŸåˆ™ï¼Œã€Œå…³æ³¨ã€ã€Œå–å…³ã€å’Œã€Œå‘æ–‡ã€åº”è¯¥æ˜¯ User çš„è¡Œä¸ºï¼Œå†µä¸”å…³æ³¨åˆ—è¡¨å’Œæ¨æ–‡åˆ—è¡¨ä¹Ÿå­˜å‚¨åœ¨ User ç±»ä¸­ï¼Œæ‰€ä»¥æˆ‘ä»¬ä¹Ÿåº”è¯¥ç»™ User æ·»åŠ  followï¼Œunfollow å’Œ post è¿™å‡ ä¸ªæ–¹æ³•ã€‚

æ¨æ–‡é“¾è¡¨é‡‡ç”¨å¤´æ’æ³•ã€‚

```java
// static int timestamp = 0
class User {
    private int id;
    public Set<Integer> followed;
    // ç”¨æˆ·å‘è¡¨çš„æ¨æ–‡é“¾è¡¨å¤´ç»“ç‚¹
    public Tweet head;

    public User(int userId) {
        followed = new HashSet<>();
        this.id = userId;
        this.head = null;
        // å…³æ³¨ä¸€ä¸‹è‡ªå·±
        follow(id);
    }

    public void follow(int userId) {
        followed.add(userId);
    }

    public void unfollow(int userId) {
        // ä¸å¯ä»¥å–å…³è‡ªå·±
        if (userId != this.id)
            followed.remove(userId);
    }

    public void post(int tweetId) {
        Tweet twt = new Tweet(tweetId, timestamp);
        timestamp++;
        // å°†æ–°å»ºçš„æ¨æ–‡æ’å…¥é“¾è¡¨å¤´
        // è¶Šé å‰çš„æ¨æ–‡ time å€¼è¶Šå¤§
        twt.next = head;
        head = twt;
    }
}
```

**3ã€å‡ ä¸ª API æ–¹æ³•çš„å®ç°**

```java
class Twitter {
    private static int timestamp = 0;
    private static class Tweet {...}
    private static class User {...}

    // æˆ‘ä»¬éœ€è¦ä¸€ä¸ªæ˜ å°„å°† userId å’Œ User å¯¹è±¡å¯¹åº”èµ·æ¥
    private HashMap<Integer, User> userMap = new HashMap<>();

    /** user å‘è¡¨ä¸€æ¡ tweet åŠ¨æ€ */
    public void postTweet(int userId, int tweetId) {
        // è‹¥ userId ä¸å­˜åœ¨ï¼Œåˆ™æ–°å»º
        if (!userMap.containsKey(userId))
            userMap.put(userId, new User(userId));
        User u = userMap.get(userId);
        u.post(tweetId);
    }

    /** follower å…³æ³¨ followee */
    public void follow(int followerId, int followeeId) {
        // è‹¥ follower ä¸å­˜åœ¨ï¼Œåˆ™æ–°å»º
        if(!userMap.containsKey(followerId)){
            User u = new User(followerId);
            userMap.put(followerId, u);
        }
        // è‹¥ followee ä¸å­˜åœ¨ï¼Œåˆ™æ–°å»º
        if(!userMap.containsKey(followeeId)){
            User u = new User(followeeId);
            userMap.put(followeeId, u);
        }
        userMap.get(followerId).follow(followeeId);
    }

    /** follower å–å…³ followeeï¼Œå¦‚æœ Id ä¸å­˜åœ¨åˆ™ä»€ä¹ˆéƒ½ä¸åš */
    public void unfollow(int followerId, int followeeId) {
        if (userMap.containsKey(followerId)) {
            User flwer = userMap.get(followerId);
            flwer.unfollow(followeeId);
        }
    }

    /** è¿”å›è¯¥ user å…³æ³¨çš„äººï¼ˆåŒ…æ‹¬ä»–è‡ªå·±ï¼‰æœ€è¿‘çš„åŠ¨æ€ idï¼Œ
    æœ€å¤š 10 æ¡ï¼Œè€Œä¸”è¿™äº›åŠ¨æ€å¿…é¡»æŒ‰ä»æ–°åˆ°æ—§çš„æ—¶é—´çº¿é¡ºåºæ’åˆ—ã€‚*/
    public List<Integer> getNewsFeed(int userId) {
        // éœ€è¦ç†è§£ç®—æ³•ï¼Œè§ä¸‹æ–‡
    }
}
```



**4ã€åˆå¹¶ k ä¸ªæœ‰åºé“¾è¡¨**

å®ç°åˆå¹¶ k ä¸ªæœ‰åºé“¾è¡¨çš„ç®—æ³•éœ€è¦ç”¨åˆ°ä¼˜å…ˆçº§é˜Ÿåˆ—ï¼ˆPriority Queueï¼‰ï¼Œè¿™ç§æ•°æ®ç»“æ„æ˜¯ã€ŒäºŒå‰å †ã€æœ€é‡è¦çš„åº”ç”¨ï¼Œä½ å¯ä»¥ç†è§£ä¸ºå®ƒå¯ä»¥å¯¹æ’å…¥çš„å…ƒç´ è‡ªåŠ¨æ’åºã€‚

![image-20210622105006791](assets/image-20210622105006791.png)

è§£é‡Šï¼šè¿™é‡Œå› ä¸ºåœ¨`PriorityQueue`æ’å…¥çš„æ˜¯`Tweet`å¯¹è±¡ï¼Œè€Œå…¶æ‹¥æœ‰å˜é‡`next`ï¼Œå› æ­¤å½“ä¸€ä¸ª`Tweet`å¯¹è±¡è¢«åŠ å…¥åˆ°resä¸­æ—¶ï¼Œå¯ä»¥ç›´æ¥ä½¿ç”¨è¯­å¥`pq.add(twt.next)`å°†twtä¸‹ä¸ªå¯¹è±¡åŠ å…¥resï¼Œè€Œä¸ç”¨åœ¨å„ä¸ªé“¾è¡¨ä¸­å¯»æ‰¾å“ªä½é“¾è¡¨å¤´ç»“ç‚¹æ˜¯twtã€‚

```java
public List<Integer> getNewsFeed(int userId) {
    List<Integer> res = new ArrayList<>();
    if (!userMap.containsKey(userId)) return res;
    // å…³æ³¨åˆ—è¡¨çš„ç”¨æˆ· Id
    Set<Integer> users = userMap.get(userId).followed;
    // è‡ªåŠ¨é€šè¿‡ time å±æ€§ä»å¤§åˆ°å°æ’åºï¼Œå®¹é‡ä¸º users çš„å¤§å°
    PriorityQueue<Tweet> pq = 
        new PriorityQueue<>(users.size(), (a, b)->(b.time - a.time));

    // å…ˆå°†æ‰€æœ‰é“¾è¡¨å¤´èŠ‚ç‚¹æ’å…¥ä¼˜å…ˆçº§é˜Ÿåˆ—
    for (int id : users) {
        Tweet twt = userMap.get(id).head;
        if (twt == null) continue;
        pq.add(twt);
    }

    while (!pq.isEmpty()) {
        // æœ€å¤šè¿”å› 10 æ¡å°±å¤Ÿäº†
        if (res.size() == 10) break;
        // å¼¹å‡º time å€¼æœ€å¤§çš„ï¼ˆæœ€è¿‘å‘è¡¨çš„ï¼‰
        Tweet twt = pq.poll();
        res.add(twt.id);
        // å°†ä¸‹ä¸€ç¯‡ Tweet æ’å…¥è¿›è¡Œæ’åº
        if (twt.next != null) 
            pq.add(twt.next);
    }
    return res;
}
```

5ã€**æ€»ç»“**

æœ¬é¢˜æŠŠåˆå¹¶å¤šä¸ªæœ‰åºé“¾è¡¨çš„ç®—æ³•å’Œé¢å‘å¯¹è±¡è®¾è®¡ï¼ˆOO designï¼‰ç»“åˆèµ·æ¥äº†ã€‚

#### äºŒå‰å †è¯¦è§£å®ç°ä¼˜å…ˆçº§é˜Ÿåˆ—

##### ä¸€ã€äºŒå‰å †æ¦‚è§ˆ

äºŒå‰å †ï¼ˆBinary Heapï¼‰æ²¡ä»€ä¹ˆç¥ç§˜ï¼Œæ€§è´¨æ¯”äºŒå‰æœç´¢æ ‘ BST è¿˜ç®€å•ã€‚å…¶ä¸»è¦æ“ä½œå°±ä¸¤ä¸ªï¼Œ`sink`ï¼ˆä¸‹æ²‰ï¼‰å’Œ `swim`ï¼ˆä¸Šæµ®ï¼‰ï¼Œç”¨ä»¥ç»´æŠ¤äºŒå‰å †çš„æ€§è´¨ã€‚å…¶ä¸»è¦åº”ç”¨æœ‰ä¸¤ä¸ªï¼Œé¦–å…ˆæ˜¯ä¸€ç§æ’åºæ–¹æ³•ã€Œå †æ’åºã€ï¼Œç¬¬äºŒæ˜¯ä¸€ç§å¾ˆæœ‰ç”¨çš„æ•°æ®ç»“æ„ã€Œä¼˜å…ˆçº§é˜Ÿåˆ—ã€ã€‚

äºŒå‰å †å…¶å®å°±æ˜¯ä¸€ç§ç‰¹æ®Šçš„äºŒå‰æ ‘ï¼ˆå®Œå…¨äºŒå‰æ ‘ï¼‰ï¼Œåªä¸è¿‡å­˜å‚¨åœ¨æ•°ç»„é‡Œã€‚ä¸€èˆ¬çš„é“¾è¡¨äºŒå‰æ ‘ï¼Œæˆ‘ä»¬æ“ä½œèŠ‚ç‚¹çš„æŒ‡é’ˆï¼Œè€Œåœ¨æ•°ç»„é‡Œï¼Œæˆ‘ä»¬æŠŠæ•°ç»„ç´¢å¼•ä½œä¸ºæŒ‡é’ˆ:

```java
// çˆ¶èŠ‚ç‚¹çš„ç´¢å¼•
int parent(int root) {
    return root / 2;
}
// å·¦å­©å­çš„ç´¢å¼•
int left(int root) {
    return root * 2;
}
// å³å­©å­çš„ç´¢å¼•
int right(int root) {
    return root * 2 + 1;
}
```

ç”»ä¸ªå›¾ä½ ç«‹å³å°±èƒ½ç†è§£äº†ï¼Œæ³¨æ„æ•°ç»„çš„ç¬¬ä¸€ä¸ªç´¢å¼• 0 ç©ºç€ä¸ç”¨

<img src="assets/image-20210622112053577.png" alt="image-20210622112053577" style="zoom:80%;" />



å¯¹äºä¸€ä¸ªæœ€å¤§å †ï¼Œæ ¹æ®å…¶æ€§è´¨ï¼Œæ˜¾ç„¶å †é¡¶ï¼Œä¹Ÿå°±æ˜¯ arr[1] ä¸€å®šæ˜¯æ‰€æœ‰å…ƒç´ ä¸­æœ€å¤§çš„å…ƒç´ ã€‚æœ¬æ–‡ä»¥æœ€å¤§å †ä¸ºä¾‹è®²è§£ã€‚

##### äºŒã€ä¼˜å…ˆçº§é˜Ÿåˆ—æ¦‚è§ˆ

ä¼˜å…ˆçº§é˜Ÿåˆ—è¿™ç§æ•°æ®ç»“æ„æœ‰ä¸€ä¸ªå¾ˆæœ‰ç”¨çš„åŠŸèƒ½ï¼Œä½ æ’å…¥æˆ–è€…åˆ é™¤å…ƒç´ çš„æ—¶å€™ï¼Œå…ƒç´ ä¼šè‡ªåŠ¨æ’åºï¼Œè¿™åº•å±‚çš„åŸç†å°±æ˜¯äºŒå‰å †çš„æ“ä½œã€‚

ä¸‹é¢æˆ‘ä»¬å®ç°ä¸€ä¸ªç®€åŒ–çš„ä¼˜å…ˆçº§é˜Ÿåˆ—ï¼Œå…ˆçœ‹ä¸‹ä»£ç æ¡†æ¶ï¼š

```java
public class MaxPQ
    <Key extends Comparable<Key>> {
    // å­˜å‚¨å…ƒç´ çš„æ•°ç»„
    private Key[] pq;
    // å½“å‰ Priority Queue ä¸­çš„å…ƒç´ ä¸ªæ•°
    private int N = 0;

    public MaxPQ(int cap) {
        // ç´¢å¼• 0 ä¸ç”¨ï¼Œæ‰€ä»¥å¤šåˆ†é…ä¸€ä¸ªç©ºé—´
        pq = (Key[]) new Comparable[cap + 1];
    }

    /* è¿”å›å½“å‰é˜Ÿåˆ—ä¸­æœ€å¤§å…ƒç´  */
    public Key max() {
        return pq[1];
    }

    /* æ’å…¥å…ƒç´  e */
    public void insert(Key e) {...}

    /* åˆ é™¤å¹¶è¿”å›å½“å‰é˜Ÿåˆ—ä¸­æœ€å¤§å…ƒç´  */
    public Key delMax() {...}

    /* ä¸Šæµ®ç¬¬ k ä¸ªå…ƒç´ ï¼Œä»¥ç»´æŠ¤æœ€å¤§å †æ€§è´¨ */
    private void swim(int k) {...}

    /* ä¸‹æ²‰ç¬¬ k ä¸ªå…ƒç´ ï¼Œä»¥ç»´æŠ¤æœ€å¤§å †æ€§è´¨ */
    private void sink(int k) {...}

    /* äº¤æ¢æ•°ç»„çš„ä¸¤ä¸ªå…ƒç´  */
    private void exch(int i, int j) {
        Key temp = pq[i];
        pq[i] = pq[j];
        pq[j] = temp;
    }

    /* pq[i] æ˜¯å¦æ¯” pq[j] å°ï¼Ÿ */
    private boolean less(int i, int j) {
        return pq[i].compareTo(pq[j]) < 0;
    }

    /* è¿˜æœ‰ left, right, parent ä¸‰ä¸ªæ–¹æ³• */
}
```

##### ä¸‰ã€å®ç° swim å’Œ sink

ä¸ºä»€ä¹ˆè¦æœ‰ä¸Šæµ® swim å’Œä¸‹æ²‰ sink çš„æ“ä½œå‘¢ï¼Ÿä¸ºäº†ç»´æŠ¤å †ç»“æ„.

ç»†å¿ƒçš„è¯»è€…ä¹Ÿè®¸ä¼šé—®ï¼Œè¿™ä¸¤ä¸ªæ“ä½œä¸æ˜¯äº’é€†å—ï¼Œæ‰€ä»¥ä¸Šæµ®çš„æ“ä½œä¸€å®šèƒ½ç”¨ä¸‹æ²‰æ¥å®Œæˆï¼Œä¸ºä»€ä¹ˆæˆ‘è¿˜è¦è´¹åŠ²å†™ä¸¤ä¸ªæ–¹æ³•ï¼Ÿ

æ˜¯çš„ï¼Œæ“ä½œæ˜¯äº’é€†ç­‰ä»·çš„ï¼Œä½†æ˜¯æœ€ç»ˆæˆ‘ä»¬çš„æ“ä½œåªä¼šåœ¨å †åº•å’Œå †é¡¶è¿›è¡Œï¼ˆç­‰ä¼šè®²åŸå› ï¼‰ï¼Œæ˜¾ç„¶å †åº•çš„ã€Œé”™ä½ã€å…ƒç´ éœ€è¦ä¸Šæµ®ï¼Œå †é¡¶çš„ã€Œé”™ä½ã€å…ƒç´ éœ€è¦ä¸‹æ²‰ã€‚

```java
private void swim(int k) {
    // å¦‚æœæµ®åˆ°å †é¡¶ï¼Œå°±ä¸èƒ½å†ä¸Šæµ®äº†
    while (k > 1 && less(parent(k), k)) {
        // å¦‚æœç¬¬ k ä¸ªå…ƒç´ æ¯”ä¸Šå±‚å¤§
        // å°† k æ¢ä¸Šå»
        exch(parent(k), k);
        k = parent(k);
    }
}
```

ä¸‹æ²‰æ¯”ä¸Šæµ®ç•¥å¾®å¤æ‚ä¸€ç‚¹ï¼Œå› ä¸ºä¸Šæµ®æŸä¸ªèŠ‚ç‚¹ Aï¼Œåªéœ€è¦ A å’Œå…¶çˆ¶èŠ‚ç‚¹æ¯”è¾ƒå¤§å°å³å¯ï¼›ä½†æ˜¯ä¸‹æ²‰æŸä¸ªèŠ‚ç‚¹ Aï¼Œéœ€è¦ A å’Œå…¶**ä¸¤ä¸ªå­èŠ‚ç‚¹**æ¯”è¾ƒå¤§å°ï¼Œå¦‚æœ A ä¸æ˜¯æœ€å¤§çš„å°±éœ€è¦è°ƒæ•´ä½ç½®ï¼Œè¦æŠŠè¾ƒå¤§çš„é‚£ä¸ªå­èŠ‚ç‚¹å’Œ A äº¤æ¢ã€‚

```java
private void sink(int k) {
    // å¦‚æœæ²‰åˆ°å †åº•ï¼Œå°±æ²‰ä¸ä¸‹å»äº†
    while (left(k) <= N) {
        // å…ˆå‡è®¾å·¦è¾¹èŠ‚ç‚¹è¾ƒå¤§
        int older = left(k);
        // å¦‚æœå³è¾¹èŠ‚ç‚¹å­˜åœ¨ï¼Œæ¯”ä¸€ä¸‹å¤§å°
        if (right(k) <= N && less(older, right(k)))
            older = right(k);
        // ç»“ç‚¹ k æ¯”ä¿©å­©å­éƒ½å¤§ï¼Œå°±ä¸å¿…ä¸‹æ²‰äº†
        if (less(older, k)) break;
        // å¦åˆ™ï¼Œä¸ç¬¦åˆæœ€å¤§å †çš„ç»“æ„ï¼Œä¸‹æ²‰ k ç»“ç‚¹
        exch(k, older);
        k = older;
    }
}
```

##### å››ã€å®ç° delMax å’Œ insert

è¿™ä¸¤ä¸ªæ–¹æ³•å°±æ˜¯å»ºç«‹åœ¨ `swim` å’Œ `sink` ä¸Šçš„ã€‚

**`insert`** **æ–¹æ³•å…ˆæŠŠè¦æ’å…¥çš„å…ƒç´ æ·»åŠ åˆ°å †åº•çš„æœ€åï¼Œç„¶åè®©å…¶ä¸Šæµ®åˆ°æ­£ç¡®ä½ç½®ã€‚**

```java
public void insert(Key e) {
    N++;
    // å…ˆæŠŠæ–°å…ƒç´ åŠ åˆ°æœ€å
    pq[N] = e;
    // ç„¶åè®©å®ƒä¸Šæµ®åˆ°æ­£ç¡®çš„ä½ç½®
    swim(N);
}
```

**`delMax`** **æ–¹æ³•å…ˆæŠŠå †é¡¶å…ƒç´  A å’Œå †åº•æœ€åçš„å…ƒç´  B å¯¹è°ƒï¼Œç„¶ååˆ é™¤ Aï¼Œæœ€åè®© B ä¸‹æ²‰åˆ°æ­£ç¡®ä½ç½®ã€‚**

```java
public Key delMax() {
    // æœ€å¤§å †çš„å †é¡¶å°±æ˜¯æœ€å¤§å…ƒç´ 
    Key max = pq[1];
    // æŠŠè¿™ä¸ªæœ€å¤§å…ƒç´ æ¢åˆ°æœ€åï¼Œåˆ é™¤ä¹‹
    exch(1, N);
    pq[N] = null;
    N--;
    // è®© pq[1] ä¸‹æ²‰åˆ°æ­£ç¡®ä½ç½®
    sink(1);
    return max;
}
```

è‡³æ­¤ï¼Œä¸€ä¸ªä¼˜å…ˆçº§é˜Ÿåˆ—å°±å®ç°äº†ï¼Œæ’å…¥å’Œåˆ é™¤å…ƒç´ çš„æ—¶é—´å¤æ‚åº¦ä¸º `O(logK)`ï¼Œ`K` ä¸ºå½“å‰äºŒå‰å †ï¼ˆä¼˜å…ˆçº§é˜Ÿåˆ—ï¼‰ä¸­çš„å…ƒç´ æ€»æ•°ã€‚

##### **äº”ã€ä»£ç å®ç°**

æ ¹æ®äºŒå‰å †ä¸Šæµ®å’Œä¸‹æ²‰çš„apiä»¥åŠä¼˜å…ˆçº§é˜Ÿåˆ—æ’å…¥å’Œåˆ é™¤çš„apiï¼Œå†™å‡ºå®Œæ•´çš„äºŒå‰å †å®ç°ä¼˜å…ˆçº§é˜Ÿåˆ—çš„ä»£ç 

```java
class MaxPQ<Key extends Comparable<Key>> {
    // å­˜å‚¨å…ƒç´ çš„æ•°ç»„
    private Key[] pq;
    // å½“å‰ Priority Queue ä¸­çš„å…ƒç´ ä¸ªæ•°
    private int N = 0;

    public MaxPQ(int cap) {
        // ç´¢å¼• 0 ä¸ç”¨ï¼Œæ‰€ä»¥å¤šåˆ†é…ä¸€ä¸ªç©ºé—´
        pq = (Key[]) new Comparable[cap + 1];
    }

    /* è¿”å›å½“å‰é˜Ÿåˆ—ä¸­æœ€å¤§å…ƒç´  */
    public Key max() {
        return pq[1];
    }

    /* æ’å…¥å…ƒç´  e */
    public void insert(Key e) {
        N++;
        // å…ˆæŠŠæ–°å…ƒç´ åŠ åˆ°æœ€å
        pq[N] = e;
        // ç„¶åè®©å®ƒä¸Šæµ®åˆ°æ­£ç¡®çš„ä½ç½®
        swim(N);
    }

    /* åˆ é™¤å¹¶è¿”å›å½“å‰é˜Ÿåˆ—ä¸­æœ€å¤§å…ƒç´  */
    public Key delMax() {
        // æœ€å¤§å †çš„å †é¡¶å°±æ˜¯æœ€å¤§å…ƒç´ 
        Key max = pq[1];
        // æŠŠè¿™ä¸ªæœ€å¤§å…ƒç´ æ¢åˆ°æœ€åï¼Œåˆ é™¤ä¹‹
        exch(1, N);
        pq[N] = null;
        N--;
        // è®© pq[1] ä¸‹æ²‰åˆ°æ­£ç¡®ä½ç½®
        sink(1);
        return max;
    }

    /* ä¸Šæµ®ç¬¬ k ä¸ªå…ƒç´ ï¼Œä»¥ç»´æŠ¤æœ€å¤§å †æ€§è´¨ */
    private void swim(int k) {
        // å¦‚æœæµ®åˆ°å †é¡¶ï¼Œå°±ä¸èƒ½å†ä¸Šæµ®äº†
        while (k > 1 && less(parent(k), k)) {
            // å¦‚æœç¬¬ k ä¸ªå…ƒç´ æ¯”ä¸Šå±‚å¤§
            // å°† k æ¢ä¸Šå»
            exch(parent(k), k);
            k = parent(k);
        }
    }

    /* ä¸‹æ²‰ç¬¬ k ä¸ªå…ƒç´ ï¼Œä»¥ç»´æŠ¤æœ€å¤§å †æ€§è´¨ */
    private void sink(int k) {
        // å¦‚æœæ²‰åˆ°å †åº•ï¼Œå°±æ²‰ä¸ä¸‹å»äº†
        while (left(k) <= N) {
            // å…ˆå‡è®¾å·¦è¾¹èŠ‚ç‚¹è¾ƒå¤§
            int older = left(k);
            // å¦‚æœå³è¾¹èŠ‚ç‚¹å­˜åœ¨ï¼Œæ¯”ä¸€ä¸‹å¤§å°
            if (right(k) <= N && less(older, right(k)))
                older = right(k);
            // ç»“ç‚¹ k æ¯”ä¿©å­©å­éƒ½å¤§ï¼Œå°±ä¸å¿…ä¸‹æ²‰äº†
            if (less(older, k))
                break;
            // å¦åˆ™ï¼Œä¸ç¬¦åˆæœ€å¤§å †çš„ç»“æ„ï¼Œä¸‹æ²‰ k ç»“ç‚¹
            exch(k, older);
            k = older;
        }
    }

    /* äº¤æ¢æ•°ç»„çš„ä¸¤ä¸ªå…ƒç´  */
    private void exch(int i, int j) {
        Key temp = pq[i];
        pq[i] = pq[j];
        pq[j] = temp;
    }

    /* pq[i] æ˜¯å¦æ¯” pq[j] å°ï¼Ÿ */
    private boolean less(int i, int j) {
        return pq[i].compareTo(pq[j]) < 0;
    }

    /* è¿˜æœ‰ left, right, parent ä¸‰ä¸ªæ–¹æ³• */
    // çˆ¶èŠ‚ç‚¹çš„ç´¢å¼•
    int parent(int root) {
        return root / 2;
    }

    // å·¦å­©å­çš„ç´¢å¼•
    int left(int root) {
        return root * 2;
    }

    // å³å­©å­çš„ç´¢å¼•
    int right(int root) {
        return root * 2 + 1;
    }
}
```

ä½¿ç”¨æ•°ç»„0ä½œä¸ºäºŒå‰å †å¤´ç»“ç‚¹ä¼šä¸ä¼šæ›´é€‚åˆæ‰‹æ’•ä»£ç å‘¢ï¼Ÿ

```java
class MaxPQ<Key extends Comparable<Key>> {
    // å­˜å‚¨å…ƒç´ çš„æ•°ç»„
    private Key[] pq;
    // å½“å‰ Priority Queue ä¸­çš„å…ƒç´ ä¸ªæ•°
    private int N = 0;

    public MaxPQ(int cap) {
        // ç´¢å¼• 0 ä¸ç”¨ï¼Œæ‰€ä»¥å¤šåˆ†é…ä¸€ä¸ªç©ºé—´
        pq = (Key[]) new Comparable[cap];
    }

    /* è¿”å›å½“å‰é˜Ÿåˆ—ä¸­æœ€å¤§å…ƒç´  */
    public Key max() {
        return pq[0];
    }

    /* æ’å…¥å…ƒç´  e */
    public void insert(Key e) {
        // å…ˆæŠŠæ–°å…ƒç´ åŠ åˆ°æœ€å
        pq[N] = e;
        // ç„¶åè®©å®ƒä¸Šæµ®åˆ°æ­£ç¡®çš„ä½ç½®
        swim(N);
        N++;
    }

    /* åˆ é™¤å¹¶è¿”å›å½“å‰é˜Ÿåˆ—ä¸­æœ€å¤§å…ƒç´  */
    public Key delMax() {
        // æœ€å¤§å †çš„å †é¡¶å°±æ˜¯æœ€å¤§å…ƒç´ 
        Key max = pq[0];
        // æŠŠè¿™ä¸ªæœ€å¤§å…ƒç´ æ¢åˆ°æœ€åï¼Œåˆ é™¤ä¹‹
        exch(0, N-1);
        pq[N-1] = null;
        N--;
        // è®© pq[0] ä¸‹æ²‰åˆ°æ­£ç¡®ä½ç½®
        sink(0);
        return max;
    }

    /* ä¸Šæµ®ç¬¬ k ä¸ªå…ƒç´ ï¼Œä»¥ç»´æŠ¤æœ€å¤§å †æ€§è´¨ */
    private void swim(int k) {
        // å¦‚æœæµ®åˆ°å †é¡¶ï¼Œå°±ä¸èƒ½å†ä¸Šæµ®äº†
        while (k > 0 && less(parent(k), k)) {
            // å¦‚æœç¬¬ k ä¸ªå…ƒç´ æ¯”ä¸Šå±‚å¤§
            // å°† k æ¢ä¸Šå»
            exch(parent(k), k);
            k = parent(k);
        }
    }

    /* ä¸‹æ²‰ç¬¬ k ä¸ªå…ƒç´ ï¼Œä»¥ç»´æŠ¤æœ€å¤§å †æ€§è´¨ */
    private void sink(int k) {
        // å¦‚æœæ²‰åˆ°å †åº•ï¼Œå°±æ²‰ä¸ä¸‹å»äº†
        while (left(k) < N) {
            // å…ˆå‡è®¾å·¦è¾¹èŠ‚ç‚¹è¾ƒå¤§
            int older = left(k);
            // å¦‚æœå³è¾¹èŠ‚ç‚¹å­˜åœ¨ï¼Œæ¯”ä¸€ä¸‹å¤§å°
            if (right(k) <= N && less(older, right(k)))
                older = right(k);
            // ç»“ç‚¹ k æ¯”ä¿©å­©å­éƒ½å¤§ï¼Œå°±ä¸å¿…ä¸‹æ²‰äº†
            if (less(older, k))
                break;
            // å¦åˆ™ï¼Œä¸ç¬¦åˆæœ€å¤§å †çš„ç»“æ„ï¼Œä¸‹æ²‰ k ç»“ç‚¹
            exch(k, older);
            k = older;
        }
    }

    /* äº¤æ¢æ•°ç»„çš„ä¸¤ä¸ªå…ƒç´  */
    private void exch(int i, int j) {
        Key temp = pq[i];
        pq[i] = pq[j];
        pq[j] = temp;
    }

    /* pq[i] æ˜¯å¦æ¯” pq[j] å°ï¼Ÿ */
    private boolean less(int i, int j) {
        return pq[i].compareTo(pq[j]) < 0;
    }

    /* è¿˜æœ‰ left, right, parent ä¸‰ä¸ªæ–¹æ³• */
    // çˆ¶èŠ‚ç‚¹çš„ç´¢å¼•
    int parent(int root) {
        return (root-1) / 2;
    }

    // å·¦å­©å­çš„ç´¢å¼•
    int left(int root) {
        return root * 2 + 1;
    }

    // å³å­©å­çš„ç´¢å¼•
    int right(int root) {
        return root * 2 + 2;
    }
}
```



##### å…­ã€æœ€åæ€»ç»“

äºŒå‰å †å°±æ˜¯ä¸€ç§å®Œå…¨äºŒå‰æ ‘ï¼Œæ‰€ä»¥é€‚åˆå­˜å‚¨åœ¨æ•°ç»„ä¸­ï¼Œè€Œä¸”äºŒå‰å †æ‹¥æœ‰ä¸€äº›ç‰¹æ®Šæ€§è´¨ã€‚

äºŒå‰å †çš„æ“ä½œå¾ˆç®€å•ï¼Œä¸»è¦å°±æ˜¯ä¸Šæµ®å’Œä¸‹æ²‰ï¼Œæ¥ç»´æŠ¤å †çš„æ€§è´¨ï¼ˆå †æœ‰åºï¼‰ï¼Œæ ¸å¿ƒä»£ç ä¹Ÿå°±åè¡Œã€‚

ä¼˜å…ˆçº§é˜Ÿåˆ—æ˜¯åŸºäºäºŒå‰å †å®ç°çš„ï¼Œä¸»è¦æ“ä½œæ˜¯æ’å…¥å’Œåˆ é™¤ã€‚**æ’å…¥æ˜¯å…ˆæ’åˆ°æœ€åï¼Œç„¶åä¸Šæµ®åˆ°æ­£ç¡®ä½ç½®ï¼›åˆ é™¤æ˜¯è°ƒæ¢ä½ç½®åå†åˆ é™¤ï¼Œç„¶åä¸‹æ²‰åˆ°æ­£ç¡®ä½ç½®ã€‚**æ ¸å¿ƒä»£ç ä¹Ÿå°±åè¡Œã€‚



å †æ’åº

```java
class HeapSort {
    public static void heapSort(int[] arr) {
        MaxPQ<Integer> pq = new MaxPQ<>(arr.length);
        for (int data : arr) {
            pq.insert(data);
        }
        int idx = 0;
        while (pq.size() > 0) {
            arr[idx++] = pq.delMax();
        }
    }
}
```

### éšæœºæ•°-ä½¿ç”¨æ•°ç»„

#### [380. O(1) æ—¶é—´æ’å…¥ã€åˆ é™¤å’Œè·å–éšæœºå…ƒç´ ](https://leetcode-cn.com/problems/insert-delete-getrandom-o1/)

<img src="assets/c985831ce7be0fdc9319df96938ce0e61592550f.png" alt="img" style="zoom:50%;" />

å¯¹äº `getRandom` æ–¹æ³•ï¼Œå¦‚æœæƒ³ã€Œç­‰æ¦‚ç‡ã€ä¸”ã€Œåœ¨ O(1) çš„æ—¶é—´ã€å–å‡ºå…ƒç´ ï¼Œä¸€å®šè¦æ»¡è¶³ï¼š**åº•å±‚ç”¨æ•°ç»„å®ç°ï¼Œä¸”æ•°ç»„å¿…é¡»æ˜¯ç´§å‡‘çš„**ã€‚

è¿™æ ·æˆ‘ä»¬å°±å¯ä»¥ç›´æ¥ç”Ÿæˆéšæœºæ•°ä½œä¸ºç´¢å¼•ï¼Œä»æ•°ç»„ä¸­å–å‡ºè¯¥éšæœºç´¢å¼•å¯¹åº”çš„å…ƒç´ ï¼Œä½œä¸ºéšæœºå…ƒç´ ã€‚

**ä½†å¦‚æœç”¨æ•°ç»„å­˜å‚¨å…ƒç´ çš„è¯ï¼Œæ’å…¥ï¼Œåˆ é™¤çš„æ—¶é—´å¤æ‚åº¦æ€ä¹ˆå¯èƒ½æ˜¯ O(1) å‘¢**ï¼Ÿ

å¯ä»¥åšåˆ°ï¼å¯¹æ•°ç»„å°¾éƒ¨è¿›è¡Œæ’å…¥å’Œåˆ é™¤æ“ä½œä¸ä¼šæ¶‰åŠæ•°æ®æ¬ç§»ï¼Œæ—¶é—´å¤æ‚åº¦æ˜¯ O(1)ã€‚

**æ‰€ä»¥ï¼Œå¦‚æœæˆ‘ä»¬æƒ³åœ¨ O(1) çš„æ—¶é—´åˆ é™¤æ•°ç»„ä¸­çš„æŸä¸€ä¸ªå…ƒç´ ** **`val`****ï¼Œå¯ä»¥å…ˆæŠŠè¿™ä¸ªå…ƒç´ äº¤æ¢åˆ°æ•°ç»„çš„å°¾éƒ¨ï¼Œç„¶åå†** **`pop`** **æ‰**ã€‚

äº¤æ¢ä¸¤ä¸ªå…ƒç´ å¿…é¡»é€šè¿‡ç´¢å¼•è¿›è¡Œäº¤æ¢å¯¹å§ï¼Œé‚£ä¹ˆæˆ‘ä»¬éœ€è¦ä¸€ä¸ªå“ˆå¸Œè¡¨ `valToIndex` æ¥è®°å½•æ¯ä¸ªå…ƒç´ å€¼å¯¹åº”çš„ç´¢å¼•ã€‚

æœ‰äº†æ€è·¯é“ºå«ï¼Œæˆ‘ä»¬ç›´æ¥çœ‹ä»£ç ï¼š

```c
class RandomizedSet {
public:
    // å­˜å‚¨å…ƒç´ çš„å€¼
    vector<int> nums;
    // è®°å½•æ¯ä¸ªå…ƒç´ å¯¹åº”åœ¨ nums ä¸­çš„ç´¢å¼•
    unordered_map<int,int> valToIndex;

    bool insert(int val) {
        // è‹¥ val å·²å­˜åœ¨ï¼Œä¸ç”¨å†æ’å…¥
        if (valToIndex.count(val)) {
            return false;
        }
        // è‹¥ val ä¸å­˜åœ¨ï¼Œæ’å…¥åˆ° nums å°¾éƒ¨ï¼Œ
        // å¹¶è®°å½• val å¯¹åº”çš„ç´¢å¼•å€¼
        valToIndex[val] = nums.size();
        nums.push_back(val);
        return true;
    }

    bool remove(int val) {
        // è‹¥ val ä¸å­˜åœ¨ï¼Œä¸ç”¨å†åˆ é™¤
        if (!valToIndex.count(val)) {
            return false;
        }
        // å…ˆæ‹¿åˆ° val çš„ç´¢å¼•
        int index = valToIndex[val];
        // å°†æœ€åä¸€ä¸ªå…ƒç´ å¯¹åº”çš„ç´¢å¼•ä¿®æ”¹ä¸º index
        valToIndex[nums.back()] = index;
        // äº¤æ¢ val å’Œæœ€åä¸€ä¸ªå…ƒç´ 
        swap(nums[index], nums.back());
        // åœ¨æ•°ç»„ä¸­åˆ é™¤å…ƒç´  val
        nums.pop_back();
        // åˆ é™¤å…ƒç´  val å¯¹åº”çš„ç´¢å¼•
        valToIndex.erase(val);
        return true;
    }

    int getRandom() {
        // éšæœºè·å– nums ä¸­çš„ä¸€ä¸ªå…ƒç´ 
        return nums[rand() % nums.size()];
    }
};
```

æ³¨æ„ `remove(val)` å‡½æ•°ï¼Œå¯¹ `nums` è¿›è¡Œæ’å…¥ã€åˆ é™¤ã€äº¤æ¢æ—¶ï¼Œéƒ½è¦è®°å¾—ä¿®æ”¹å“ˆå¸Œè¡¨ `valToIndex`ï¼Œå¦åˆ™ä¼šå‡ºç°é”™è¯¯ã€‚

#### [710. é»‘åå•ä¸­çš„éšæœºæ•°](https://leetcode-cn.com/problems/random-pick-with-blacklist/)

![image-20210705161012058](assets/image-20210705161012058.png)

* å“ˆå¸Œæ³•



**èªæ˜çš„è§£æ³•ç±»ä¼¼ä¸Šä¸€é“é¢˜ï¼Œæˆ‘ä»¬å¯ä»¥å°†åŒºé—´** **`[0,N)`** **çœ‹åšä¸€ä¸ªæ•°ç»„ï¼Œç„¶åå°†** **`blacklist`** **ä¸­çš„å…ƒç´ ç§»åˆ°æ•°ç»„çš„æœ€æœ«å°¾ï¼ŒåŒæ—¶ç”¨ä¸€ä¸ªå“ˆå¸Œè¡¨è¿›è¡Œæ˜ å°„**ï¼š

**ç¬¬ä¸€ä¸ªé—®é¢˜**ï¼Œ**åœ¨å¯¹** **`mapping[b]`** **èµ‹å€¼æ—¶ï¼Œè¦ä¿è¯** **`last`** **ä¸€å®šä¸åœ¨** **`blacklist`** **ä¸­**

**ç¬¬äºŒä¸ªé—®é¢˜**ï¼Œå¦‚æœ `blacklist` ä¸­çš„é»‘åå•æ•°å­—æœ¬èº«å°±å­˜åœ¨åŒºé—´ `[sz, N)` ä¸­ï¼Œé‚£ä¹ˆå°±æ²¡å¿…è¦åœ¨ `mapping` ä¸­å»ºç«‹æ˜ å°„

```java
class Solution {
public:
    int sz;
    unordered_map<int, int> mapping;

    Solution(int N, vector<int>& blacklist) {
        sz = N - blacklist.size();
        for (int b : blacklist) {
            mapping[b] = 666;
        }

        int last = N - 1;
        for (int b : blacklist) {
            // å¦‚æœ b å·²ç»åœ¨åŒºé—´ [sz, N)
            // å¯ä»¥ç›´æ¥å¿½ç•¥
            if (b >= sz) {
                continue;
            }
            while (mapping.count(last)) {
                last--;
            }
            mapping[b] = last;
            last--;
        }
    }

    // è§ä¸Šæ–‡ä»£ç å®ç°
    int pick() {
        // éšæœºé€‰å–ä¸€ä¸ªç´¢å¼•
        int index = rand() % sz;
        // è¿™ä¸ªç´¢å¼•å‘½ä¸­äº†é»‘åå•ï¼Œ
        // éœ€è¦è¢«æ˜ å°„åˆ°å…¶ä»–ä½ç½®
        if (mapping.count(index)) {
            return mapping[index];
        }
        // è‹¥æ²¡å‘½ä¸­é»‘åå•ï¼Œåˆ™ç›´æ¥è¿”å›
        return index;
    }
};
```

è‡³æ­¤ï¼Œè¿™é“é¢˜ä¹Ÿè§£å†³äº†ï¼Œæ€»ç»“ä¸€ä¸‹æœ¬æ–‡çš„æ ¸å¿ƒæ€æƒ³ï¼š

1ã€å¦‚æœæƒ³é«˜æ•ˆåœ°ï¼Œç­‰æ¦‚ç‡åœ°éšæœºè·å–å…ƒç´ ï¼Œå°±è¦ä½¿ç”¨æ•°ç»„ä½œä¸ºåº•å±‚å®¹å™¨ã€‚

2ã€å¦‚æœè¦ä¿æŒæ•°ç»„å…ƒç´ çš„ç´§å‡‘æ€§ï¼Œå¯ä»¥æŠŠå¾…åˆ é™¤å…ƒç´ æ¢åˆ°æœ€åï¼Œç„¶å `pop` æ‰æœ«å°¾çš„å…ƒç´ ï¼Œè¿™æ ·æ—¶é—´å¤æ‚åº¦å°±æ˜¯ O(1) äº†ã€‚å½“ç„¶ï¼Œæˆ‘ä»¬éœ€è¦é¢å¤–çš„å“ˆå¸Œè¡¨è®°å½•å€¼åˆ°ç´¢å¼•çš„æ˜ å°„ã€‚

3ã€å¯¹äºç¬¬äºŒé¢˜ï¼Œæ•°ç»„ä¸­å«æœ‰ã€Œç©ºæ´ã€ï¼ˆé»‘åå•æ•°å­—ï¼‰ï¼Œä¹Ÿå¯ä»¥åˆ©ç”¨å“ˆå¸Œè¡¨å·§å¦™å¤„ç†æ˜ å°„å…³ç³»ï¼Œè®©æ•°ç»„åœ¨é€»è¾‘ä¸Šæ˜¯ç´§å‡‘çš„ï¼Œæ–¹ä¾¿éšæœºå–å…ƒç´ ã€‚